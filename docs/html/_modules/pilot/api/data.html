
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pilot.api.data &#8212; Pilot 2  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pilot.api.data</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># - Mario Lassnig, mario.lassnig@cern.ch, 2017</span>
<span class="c1"># - Paul Nilsson, paul.nilsson@cern.ch, 2017-2019</span>
<span class="c1"># - Tobias Wegner, tobias.wegner@cern.ch, 2017-2018</span>
<span class="c1"># - Alexey Anisenkov, anisyonk@cern.ch, 2018-2019</span>

<span class="c1"># refactored by Alexey Anisenkov</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>  <span class="c1"># Python 3</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">pilot.info</span> <span class="kn">import</span> <span class="n">infosys</span>
<span class="kn">from</span> <span class="nn">pilot.common.exception</span> <span class="kn">import</span> <span class="n">PilotException</span><span class="p">,</span> <span class="n">ErrorCodes</span><span class="p">,</span> <span class="n">SizeTooLarge</span><span class="p">,</span> <span class="n">NoLocalSpace</span><span class="p">,</span> <span class="n">ReplicasNotFound</span>
<span class="kn">from</span> <span class="nn">pilot.util.auxiliary</span> <span class="kn">import</span> <span class="n">show_memory_usage</span>
<span class="kn">from</span> <span class="nn">pilot.util.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">pilot.util.filehandling</span> <span class="kn">import</span> <span class="n">calculate_checksum</span><span class="p">,</span> <span class="n">write_json</span>
<span class="kn">from</span> <span class="nn">pilot.util.math</span> <span class="kn">import</span> <span class="n">convert_mb_to_b</span>
<span class="kn">from</span> <span class="nn">pilot.util.parameters</span> <span class="kn">import</span> <span class="n">get_maximum_input_sizes</span>
<span class="kn">from</span> <span class="nn">pilot.util.workernode</span> <span class="kn">import</span> <span class="n">get_local_disk_space</span>
<span class="kn">from</span> <span class="nn">pilot.util.timer</span> <span class="kn">import</span> <span class="n">TimeoutException</span>
<span class="kn">from</span> <span class="nn">pilot.util.tracereport</span> <span class="kn">import</span> <span class="n">TraceReport</span>


<div class="viewcode-block" id="StagingClient"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient">[docs]</a><span class="k">class</span> <span class="nc">StagingClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base Staging Client</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># stage-in/out, set by the inheritor of the class</span>
    <span class="n">copytool_modules</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rucio&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="s1">&#39;rucio&#39;</span><span class="p">},</span>
                        <span class="s1">&#39;gfal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="s1">&#39;gfal&#39;</span><span class="p">},</span>
                        <span class="s1">&#39;gfalcopy&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="s1">&#39;gfal&#39;</span><span class="p">},</span>
                        <span class="s1">&#39;xrdcp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="s1">&#39;xrdcp&#39;</span><span class="p">},</span>
                        <span class="s1">&#39;mv&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="s1">&#39;mv&#39;</span><span class="p">},</span>
                        <span class="s1">&#39;lsm&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="s1">&#39;lsm&#39;</span><span class="p">}</span>
                        <span class="p">}</span>

    <span class="c1"># list of allowed schemas to be used for direct acccess mode from REMOTE replicas</span>
    <span class="n">direct_remoteinput_allowed_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]</span>
    <span class="c1"># list of schemas to be used for direct acccess mode from LOCAL replicas</span>
    <span class="n">direct_localinput_allowed_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;dcache&#39;</span><span class="p">,</span> <span class="s1">&#39;dcap&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]</span>
    <span class="c1"># list of allowed schemas to be used for transfers from REMOTE sites</span>
    <span class="n">remoteinput_allowed_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;gsiftp&#39;</span><span class="p">,</span> <span class="s1">&#39;dcap&#39;</span><span class="p">,</span> <span class="s1">&#39;davs&#39;</span><span class="p">,</span> <span class="s1">&#39;srm&#39;</span><span class="p">,</span> <span class="s1">&#39;storm&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="StagingClient.__init__"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infosys_instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acopytools</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_copytools</span><span class="o">=</span><span class="s1">&#39;rucio&#39;</span><span class="p">,</span> <span class="n">trace_report</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If `acopytools` is not specified then it will be automatically resolved via infosys. In this case `infosys` requires initialization.</span>
<span class="sd">            :param acopytools: dict of copytool names per activity to be used for transfers. Accepts also list of names or string value without activity passed.</span>
<span class="sd">            :param logger: logging.Logger object to use for logging (None means no logging)</span>
<span class="sd">            :param default_copytools: copytool name(s) to be used in case of unknown activity passed. Accepts either list of names or single string value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">StagingClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span> <span class="o">=</span> <span class="n">infosys_instance</span> <span class="ow">or</span> <span class="n">infosys</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acopytools</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># Python 2  # noqa: F821</span>
                <span class="n">acopytools</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">acopytools</span><span class="p">]}</span> <span class="k">if</span> <span class="n">acopytools</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acopytools</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># Python 3</span>
                <span class="n">acopytools</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">acopytools</span><span class="p">]}</span> <span class="k">if</span> <span class="n">acopytools</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acopytools</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">acopytools</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">acopytools</span><span class="p">}</span> <span class="k">if</span> <span class="n">acopytools</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span> <span class="o">=</span> <span class="n">acopytools</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_acopytools</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_copytools</span><span class="p">(</span><span class="n">default_copytools</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;failed to initilize StagingClient: no acopytools options found, acopytools=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clientState</span><span class="o">=</span><span class="s1">&#39;BAD_COPYTOOL&#39;</span><span class="p">,</span> <span class="n">stateReason</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s2">&quot;failed to resolve acopytools settings&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;configured copytools per activity: acopytools=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="p">)</span>

        <span class="c1"># get an initialized trace report (has to be updated for get/put if not defined before)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span> <span class="o">=</span> <span class="n">trace_report</span> <span class="k">if</span> <span class="n">trace_report</span> <span class="k">else</span> <span class="n">TraceReport</span><span class="p">(</span><span class="n">pq</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_SITENAME&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="StagingClient.set_acopytools"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.set_acopytools">[docs]</a>    <span class="k">def</span> <span class="nf">set_acopytools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the internal acopytools.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="p">:</span>  <span class="c1"># resolve from queuedata.acopytools using infosys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">acopytools</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="p">:</span>  <span class="c1"># resolve from queuedata.copytools using infosys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">copytools</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>  <span class="c1"># Python 2/3</span></div>
            <span class="c1">#self.acopytools = dict(default=(self.infosys.queuedata.copytools or {}).keys())  # Python 2</span>

<div class="viewcode-block" id="StagingClient.get_default_copytools"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.get_default_copytools">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_default_copytools</span><span class="p">(</span><span class="n">default_copytools</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the default copytools.</span>

<span class="sd">        :param default_copytools:</span>
<span class="sd">        :return: default copytools (string).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_copytools</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># Python 2 # noqa: F821</span>
                <span class="n">default_copytools</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_copytools</span><span class="p">]</span> <span class="k">if</span> <span class="n">default_copytools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_copytools</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># Python 3</span>
                <span class="n">default_copytools</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_copytools</span><span class="p">]</span> <span class="k">if</span> <span class="n">default_copytools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">default_copytools</span></div>

<div class="viewcode-block" id="StagingClient.get_preferred_replica"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.get_preferred_replica">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_preferred_replica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicas</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get preferred replica from the `replicas` list suitable for `allowed_schemas`</span>
<span class="sd">            :return: first matched replica or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">:</span>
            <span class="n">pfn</span> <span class="o">=</span> <span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pfn&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">allowed_schemas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pfn</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">schema</span> <span class="ow">or</span> <span class="n">pfn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://&#39;</span> <span class="o">%</span> <span class="n">schema</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">replica</span></div>

<div class="viewcode-block" id="StagingClient.prepare_sources"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.prepare_sources">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">activities</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Customize/prepare source data for each entry in `files` optionally checking data for requested `activities`</span>
<span class="sd">            (custom StageClient could extend the logic if need)</span>
<span class="sd">            :param files: list of `FileSpec` objects to be processed</span>
<span class="sd">            :param activities: string or ordered list of activities to resolve `astorages` (optional)</span>
<span class="sd">            :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="StagingClient.prepare_inputddms"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.prepare_inputddms">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_inputddms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">activities</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Populates filespec.inputddms for each entry from `files` list</span>
<span class="sd">            :param files: list of `FileSpec` objects</span>
<span class="sd">            :param activities: sting or ordered list of activities to resolve astorages (optional)</span>
<span class="sd">            :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">activities</span> <span class="o">=</span> <span class="n">activities</span> <span class="ow">or</span> <span class="s1">&#39;read_lan&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activities</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># Python 2  # noqa: F821</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="p">[</span><span class="n">activities</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activities</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># Python 3</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="p">[</span><span class="n">activities</span><span class="p">]</span>

        <span class="n">astorages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">astorages</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">storages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
            <span class="n">storages</span> <span class="o">=</span> <span class="n">astorages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">storages</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1">#activity = activities[0]</span>
        <span class="c1">#if not storages:  ## ignore empty astorages</span>
        <span class="c1">#    raise PilotException(&quot;Failed to resolve input sources: no associated storages defined for activity=%s (%s)&quot;</span>
        <span class="c1">#                         % (activity, &#39;,&#39;.join(activities)), code=ErrorCodes.NOSTORAGE, state=&#39;NO_ASTORAGES_DEFINED&#39;)</span>

        <span class="k">for</span> <span class="n">fdat</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">inputddms</span><span class="p">:</span>
                <span class="n">fdat</span><span class="o">.</span><span class="n">inputddms</span> <span class="o">=</span> <span class="n">storages</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">inputddms</span> <span class="ow">and</span> <span class="n">fdat</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">:</span>
                <span class="n">fdat</span><span class="o">.</span><span class="n">inputddms</span> <span class="o">=</span> <span class="p">[</span><span class="n">fdat</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">]</span></div>

<div class="viewcode-block" id="StagingClient.sort_replicas"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.sort_replicas">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sort_replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicas</span><span class="p">,</span> <span class="n">inputddms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort input replicas: consider first affected replicas from inputddms</span>
<span class="sd">        :param replicas: Prioritized list of replicas [(pfn, dat)]</span>
<span class="sd">        :param inputddms: preferred list of ddmebdpoint</span>
<span class="sd">        :return: sorted `replicas`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inputddms</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">replicas</span>

        <span class="c1"># group replicas by ddmendpoint to properly consider priority of inputddms</span>
        <span class="n">ddmreplicas</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">xdat</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">:</span>
            <span class="n">ddmreplicas</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rse&#39;</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pfn</span><span class="p">,</span> <span class="n">xdat</span><span class="p">))</span>

        <span class="c1"># process LAN first (keep fspec.inputddms priorities)</span>
        <span class="n">xreplicas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ddm</span> <span class="ow">in</span> <span class="n">inputddms</span><span class="p">:</span>
            <span class="n">xreplicas</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ddmreplicas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ddm</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="k">for</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">xdat</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">xdat</span><span class="p">)</span> <span class="ow">in</span> <span class="n">xreplicas</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">xreplicas</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pfn</span><span class="p">,</span> <span class="n">xdat</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">replicas</span></div>

<div class="viewcode-block" id="StagingClient.resolve_replicas"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.resolve_replicas">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">use_vp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates filespec.replicas for each entry from `files` list</span>

<span class="sd">            fdat.replicas = [{&#39;ddmendpoint&#39;:&#39;ddmendpoint&#39;, &#39;pfn&#39;:&#39;replica&#39;, &#39;domain&#39;:&#39;domain value&#39;}]</span>

<span class="sd">        :param files: list of `FileSpec` objects.</span>
<span class="sd">        :param use_vp: True for VP jobs (boolean).</span>
<span class="sd">        :return: `files`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">xfiles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">show_memory_usage</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fdat</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1">## skip fdat if need for further workflow (e.g. to properly handle OS ddms)</span>
            <span class="n">xfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdat</span><span class="p">)</span>

        <span class="n">show_memory_usage</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">xfiles</span><span class="p">:</span>  <span class="c1"># no files for replica look-up</span>
            <span class="k">return</span> <span class="n">files</span>

        <span class="c1"># load replicas from Rucio</span>
        <span class="kn">from</span> <span class="nn">rucio.client</span> <span class="kn">import</span> <span class="n">Client</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

        <span class="n">show_memory_usage</span><span class="p">()</span>

        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_client_location</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">location</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s2">&quot;Failed to get client location for Rucio&quot;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">RUCIOLOCATIONFAILED</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;schemes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;srm&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;davs&#39;</span><span class="p">,</span> <span class="s1">&#39;gsiftp&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span> <span class="s1">&#39;storm&#39;</span><span class="p">],</span>
            <span class="s1">&#39;dids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">xfiles</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="s1">&#39;geoip&#39;</span><span class="p">,</span> <span class="n">client_location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="c1"># reset the schemas for VP jobs</span>
        <span class="k">if</span> <span class="n">use_vp</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;schemes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;rse_expression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;istape=False</span><span class="se">\\</span><span class="s1">type=SPECIAL&#39;</span>

        <span class="c1"># add signature lifetime for signed URL storages</span>
        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">signature_lifetime</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>  <span class="c1"># note: default is otherwise 1h</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;calling rucio.list_replicas() with query=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">replicas</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">list_replicas</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s2">&quot;Failed to get replicas from Rucio: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">RUCIOLISTREPLICASFAILED</span><span class="p">)</span>

        <span class="n">show_memory_usage</span><span class="p">()</span>

        <span class="n">replicas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">replicas</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;replicas received from Rucio: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">replicas</span><span class="p">)</span>

        <span class="n">files_lfn</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">e</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">lfn</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">xfiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">],</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">fdat</span> <span class="o">=</span> <span class="n">files_lfn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="p">:</span>  <span class="c1"># not requested replica</span>
                <span class="k">continue</span>

            <span class="c1"># add the replicas to the fdat structure</span>
            <span class="n">fdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_replicas</span><span class="p">(</span><span class="n">fdat</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>

            <span class="c1"># verify filesize and checksum values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validateStart</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">fdat</span><span class="o">.</span><span class="n">filesize</span> <span class="o">!=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Filesize of input file=</span><span class="si">%s</span><span class="s2"> mismatched with value from Rucio replica: filesize=</span><span class="si">%s</span><span class="s2">, replica.filesize=</span><span class="si">%s</span><span class="s2">, fdat=</span><span class="si">%s</span><span class="s2">&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">fdat</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">fdat</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">],</span> <span class="n">fdat</span><span class="p">))</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">filesize</span><span class="p">:</span>
                <span class="n">fdat</span><span class="o">.</span><span class="n">filesize</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Filesize value for input file=</span><span class="si">%s</span><span class="s2"> is not defined, assigning info from Rucio replica: filesize=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fdat</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;adler32&#39;</span><span class="p">,</span> <span class="s1">&#39;md5&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">fdat</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">replica</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span> <span class="ow">and</span> <span class="n">replica</span><span class="p">[</span><span class="n">ctype</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Checksum value of input file=</span><span class="si">%s</span><span class="s2"> mismatched with info got from Rucio replica: checksum=</span><span class="si">%s</span><span class="s2">, replica.checksum=</span><span class="si">%s</span><span class="s2">, fdat=</span><span class="si">%s</span><span class="s2">&quot;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">fdat</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">fdat</span><span class="o">.</span><span class="n">checksum</span><span class="p">,</span> <span class="n">replica</span><span class="p">[</span><span class="n">ctype</span><span class="p">],</span> <span class="n">fdat</span><span class="p">))</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">replica</span><span class="p">[</span><span class="n">ctype</span><span class="p">]:</span>
                    <span class="n">fdat</span><span class="o">.</span><span class="n">checksum</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;filesize and checksum verification done&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clientState</span><span class="o">=</span><span class="s2">&quot;DONE&quot;</span><span class="p">)</span>

        <span class="n">show_memory_usage</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of resolved replicas:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;lfn=</span><span class="si">%s</span><span class="s2">: replicas=</span><span class="si">%s</span><span class="s2">, is_directaccess=</span><span class="si">%s</span><span class="s2">&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">replicas</span> <span class="ow">or</span> <span class="p">[]),</span> <span class="n">f</span><span class="o">.</span><span class="n">is_directaccess</span><span class="p">(</span><span class="n">ensure_replica</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="StagingClient.add_replicas"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.add_replicas">[docs]</a>    <span class="k">def</span> <span class="nf">add_replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fdat</span><span class="p">,</span> <span class="n">replica</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the replicas to the fdat structure.</span>

<span class="sd">        :param fdat:</span>
<span class="sd">        :param replica:</span>
<span class="sd">        :return: updated fdat.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fdat</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># reset replicas list</span>

        <span class="c1"># sort replicas by priority value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sorted_replicas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pfns&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span>  <span class="c1"># Python 2</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sorted_replicas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pfns&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
                                     <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span>  <span class="c1"># Python 3</span>

        <span class="c1"># prefer replicas from inputddms first</span>
        <span class="n">xreplicas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_replicas</span><span class="p">(</span><span class="n">sorted_replicas</span><span class="p">,</span> <span class="n">fdat</span><span class="o">.</span><span class="n">inputddms</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">xdat</span> <span class="ow">in</span> <span class="n">xreplicas</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">xdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;DISK&#39;</span><span class="p">:</span>  <span class="c1"># consider only DISK replicas</span>
                <span class="k">continue</span>

            <span class="n">rinfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pfn&#39;</span><span class="p">:</span> <span class="n">pfn</span><span class="p">,</span> <span class="s1">&#39;ddmendpoint&#39;</span><span class="p">:</span> <span class="n">xdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rse&#39;</span><span class="p">),</span> <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="n">xdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)}</span>

            <span class="c1">## (TEMPORARY?) consider fspec.inputddms as a primary source for local/lan source list definition</span>
            <span class="c1">## backward compartible logic -- FIX ME LATER if NEED</span>
            <span class="c1">## in case we should rely on domain value from Rucio, just remove the overwrite line below</span>
            <span class="n">rinfo</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lan&#39;</span> <span class="k">if</span> <span class="n">rinfo</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">fdat</span><span class="o">.</span><span class="n">inputddms</span> <span class="k">else</span> <span class="s1">&#39;wan&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">allow_lan</span> <span class="ow">and</span> <span class="n">rinfo</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lan&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">allow_wan</span> <span class="ow">and</span> <span class="n">rinfo</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wan&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">fdat</span><span class="o">.</span><span class="n">replicas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rinfo</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fdat</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no replicas were selected (verify replica type, allow_lan/wan and domain values)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fdat</span></div>

<div class="viewcode-block" id="StagingClient.detect_client_location"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.detect_client_location">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">detect_client_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a UDP socket to a machine on the internet, to get the local IPv4 and IPv6</span>
<span class="sd">        addresses of the requesting client.</span>
<span class="sd">        Try to determine the sitename automatically from common environment variables,</span>
<span class="sd">        in this order: SITE_NAME, ATLAS_SITE_NAME, OSG_SITE_NAME. If none of these exist</span>
<span class="sd">        use the fixed string &#39;ROAMING&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">socket</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">ip6</span> <span class="o">=</span> <span class="s1">&#39;::&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;2001:4860:4860:0:0:0:0:8888&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
            <span class="n">ip6</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">site</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_RUCIO_SITENAME&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<span class="c1">#        site = os.environ.get(&#39;SITE_NAME&#39;,</span>
<span class="c1">#                              os.environ.get(&#39;ATLAS_SITE_NAME&#39;,</span>
<span class="c1">#                                             os.environ.get(&#39;OSG_SITE_NAME&#39;,</span>
<span class="c1">#                                                            &#39;ROAMING&#39;)))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;ip6&#39;</span><span class="p">:</span> <span class="n">ip6</span><span class="p">,</span>
                <span class="s1">&#39;fqdn&#39;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(),</span>
                <span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">site</span><span class="p">}</span></div>

<div class="viewcode-block" id="StagingClient.transfer_files"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.transfer_files">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copytool</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Apply transfer of given `files` using passed `copytool` module</span>
<span class="sd">            Should be implemented by custom Staging Client</span>
<span class="sd">            :param copytool: copytool module</span>
<span class="sd">            :param files: list of `FileSpec` objects</span>
<span class="sd">            :param kwargs: extra kwargs to be passed to copytool transfer handler</span>
<span class="sd">            :raise: PilotException in case of controlled error</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="StagingClient.transfer"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.transfer">[docs]</a>    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">activity</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Automatically stage passed files using copy tools related to given `activity`</span>
<span class="sd">            :param files: list of `FileSpec` objects</span>
<span class="sd">            :param activity: list of activity names used to determine appropriate copytool (prioritized list)</span>
<span class="sd">            :param kwargs: extra kwargs to be passed to copytool transfer handler</span>
<span class="sd">            :raise: PilotException in case of controlled error</span>
<span class="sd">            :return: list of processed `FileSpec` objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">relativeStart</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">transferStart</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># Python 2 # noqa: F821</span>
                <span class="n">activity</span> <span class="o">=</span> <span class="p">[</span><span class="n">activity</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># Python 3</span>
                <span class="n">activity</span> <span class="o">=</span> <span class="p">[</span><span class="n">activity</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
            <span class="n">activity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">copytools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
            <span class="n">copytools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">copytools</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">copytools</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s1">&#39;failed to resolve copytool by preferred activities=</span><span class="si">%s</span><span class="s1">, acopytools=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acopytools</span><span class="p">))</span>

        <span class="c1"># populate inputddms if need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputddms</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="c1"># initialize ddm_activity name for requested files if not set</span>
        <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddm_activity</span><span class="p">:</span>  <span class="c1"># skip already initialized data</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;stage-in&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">executor_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;raythena&#39;</span><span class="p">:</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;no_transfer&#39;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">ddm_activity</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;read_lan&#39;</span> <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">inputddms</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;read_wan&#39;</span><span class="p">])</span>  <span class="c1"># Python 2</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">ddm_activity</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span>
                                          <span class="p">[</span><span class="s1">&#39;read_lan&#39;</span> <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">inputddms</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;read_wan&#39;</span><span class="p">]</span> <span class="k">if</span>
                                          <span class="n">_f</span><span class="p">]</span>  <span class="c1"># Python 3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">ddm_activity</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;write_lan&#39;</span> <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">inputddms</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;write_wan&#39;</span><span class="p">])</span>  <span class="c1"># Python 2</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">ddm_activity</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span>
                                          <span class="p">[</span><span class="s1">&#39;write_lan&#39;</span> <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">inputddms</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;write_wan&#39;</span><span class="p">]</span>
                                          <span class="k">if</span> <span class="n">_f</span><span class="p">]</span>  <span class="c1"># Python 3</span>
        <span class="n">caught_errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">copytools</span><span class="p">:</span>

            <span class="c1"># get remain files that need to be transferred by copytool</span>
            <span class="n">remain_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;remote_io&#39;</span><span class="p">,</span> <span class="s1">&#39;transferred&#39;</span><span class="p">,</span> <span class="s1">&#39;no_transfer&#39;</span><span class="p">]]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">remain_files</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">copytool_modules</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s1">&#39;passed unknown copytool with name=</span><span class="si">%s</span><span class="s1"> .. skipped&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                         <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">UNKNOWNCOPYTOOL</span><span class="p">)</span>

                <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copytool_modules</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;module_name&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;trying to use copytool=</span><span class="si">%s</span><span class="s1"> for activity=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">activity</span><span class="p">))</span>
                <span class="n">copytool</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.copytool.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">module</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">module</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2/3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">PilotException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">caught_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to import copytool module=</span><span class="si">%s</span><span class="s1">, error=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;kwargs=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_files</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="n">remain_files</span><span class="p">,</span> <span class="n">activity</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;transfer_files() using copytool=</span><span class="si">%s</span><span class="s1"> completed with result=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
                <span class="n">show_memory_usage</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">PilotException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to transfer_files() using copytool=</span><span class="si">%s</span><span class="s1"> .. skipped; error=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">caught_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;function timed out: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">caught_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to transfer files using copytool=</span><span class="si">%s</span><span class="s1"> .. skipped; error=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">caught_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">caught_errors</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PilotException</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="n">caught_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_error_code</span><span class="p">()</span> <span class="o">==</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">MISSINGOUTPUTFILE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">caught_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">remain_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;remote_io&#39;</span><span class="p">,</span> <span class="s1">&#39;transferred&#39;</span><span class="p">,</span> <span class="s1">&#39;no_transfer&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">remain_files</span><span class="p">:</span>  <span class="c1"># failed or incomplete transfer</span>
            <span class="c1"># Propagate message from first error back up</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">caught_errors</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">caught_errors</span> <span class="ow">and</span> <span class="s2">&quot;Cannot authenticate&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">STAGEINAUTHENTICATIONFAILURE</span>
            <span class="k">elif</span> <span class="n">caught_errors</span> <span class="ow">and</span> <span class="s2">&quot;bad queue configuration&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">BADQUEUECONFIGURATION</span>
            <span class="k">elif</span> <span class="n">caught_errors</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PilotException</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">caught_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_error_code</span><span class="p">()</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="n">caught_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_last_error</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">caught_errors</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TimeoutException</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">STAGEINTIMEOUT</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;stage-in&#39;</span> <span class="k">else</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">STAGEOUTTIMEOUT</span>  <span class="c1"># is it stage-in/out?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;caught time-out exception: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">caught_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">STAGEINFAILED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;stage-in&#39;</span> <span class="k">else</span> <span class="n">ErrorCodes</span><span class="o">.</span><span class="n">STAGEOUTFAILED</span>  <span class="c1"># is it stage-in/out?</span>
            <span class="n">details</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">caught_errors</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="s1">&#39;failed to transfer files using copytools=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">copytools</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="StagingClient.require_protocols"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.require_protocols">[docs]</a>    <span class="k">def</span> <span class="nf">require_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">copytool</span><span class="p">,</span> <span class="n">activity</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Populates fspec.protocols and fspec.turl for each entry in `files` according to preferred fspec.ddm_activity</span>
<span class="sd">            :param files: list of `FileSpec` objects</span>
<span class="sd">            :param activity: str or ordered list of transfer activity names to resolve acopytools related data</span>
<span class="sd">            :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;allowed_schemas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">:</span>
            <span class="n">copytool_name</span> <span class="o">=</span> <span class="n">copytool</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">resolve_allowed_schemas</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">copytool_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">allowed_schemas</span>

        <span class="k">if</span> <span class="n">local_dir</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fdat</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">local_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="n">local_dir</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
                <span class="n">fdat</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">local_dir</span><span class="p">,</span> <span class="s1">&#39;flavour&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_protocols</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="n">ddmconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">resolve_storage_data</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_protocol</span><span class="p">(</span><span class="n">fspec</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">protocols</span> <span class="ow">and</span> <span class="s1">&#39;mv&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">copytools</span><span class="p">:</span>  <span class="c1"># no protocols found</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Failed to resolve protocol for file=</span><span class="si">%s</span><span class="s1">, allowed_schemas=</span><span class="si">%s</span><span class="s1">, fspec=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">,</span> <span class="n">fspec</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;resolve_protocol: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">NOSTORAGEPROTOCOL</span><span class="p">)</span>

            <span class="c1"># take first available protocol for copytool: FIX ME LATER if need (do iterate over all allowed protocols?)</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resolved protocol to be used for transfer: </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">: lfn=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">))</span>

            <span class="n">resolve_surl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;resolve_surl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">resolve_surl</span><span class="p">):</span>
                <span class="n">resolve_surl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_surl</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">resolve_surl</span><span class="p">(</span><span class="n">fspec</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">ddmconf</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="n">local_dir</span><span class="p">)</span>  <span class="c1"># pass ddmconf for possible custom look up at the level of copytool</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;r=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;surl&#39;</span><span class="p">):</span>
                <span class="n">fspec</span><span class="o">.</span><span class="n">turl</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;surl&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">):</span>
                <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="StagingClient.resolve_protocols"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.resolve_protocols">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Populates filespec.protocols for each entry from `files` according to preferred `fspec.ddm_activity` value</span>
<span class="sd">            :param files: list of `FileSpec` objects</span>
<span class="sd">            fdat.protocols = [dict(endpoint, path, flavour), ..]</span>
<span class="sd">            :return: `files`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ddmconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">resolve_storage_data</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fdat</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">ddm</span> <span class="o">=</span> <span class="n">ddmconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fdat</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddm</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Failed to resolve output ddmendpoint by name=</span><span class="si">%s</span><span class="s1"> (from PanDA), please check configuration.&#39;</span> <span class="o">%</span> <span class="n">fdat</span><span class="o">.</span><span class="n">ddmendpoint</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;resolve_protocols: </span><span class="si">%s</span><span class="s2">, fspec=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">fdat</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">NOSTORAGE</span><span class="p">)</span>

            <span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">fdat</span><span class="o">.</span><span class="n">ddm_activity</span><span class="p">:</span>
                <span class="n">protocols</span> <span class="o">=</span> <span class="n">ddm</span><span class="o">.</span><span class="n">arprotocols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">protocols</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">fdat</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="n">protocols</span>

        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="StagingClient.resolve_protocol"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StagingClient.resolve_protocol">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">resolve_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspec</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Resolve protocols according to allowed schema</span>
<span class="sd">            :param fspec: `FileSpec` instance</span>
<span class="sd">            :param allowed_schemas: list of allowed schemas or any if None</span>
<span class="sd">            :return: list of dict(endpoint, path, flavour)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fspec</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="n">allowed_schemas</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">allowed_schemas</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pdat</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;endpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">://&quot;</span> <span class="o">%</span> <span class="n">schema</span><span class="p">):</span>
                    <span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdat</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">protocols</span></div></div>


<div class="viewcode-block" id="StageInClient"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageInClient">[docs]</a><span class="k">class</span> <span class="nc">StageInClient</span><span class="p">(</span><span class="n">StagingClient</span><span class="p">):</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stage-in&quot;</span>

<div class="viewcode-block" id="StageInClient.resolve_replica"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageInClient.resolve_replica">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_replica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspec</span><span class="p">,</span> <span class="n">primary_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Resolve input replica (matched by `domain` if need) first according to `primary_schemas`,</span>
<span class="sd">            if not found then look up within `allowed_schemas`</span>
<span class="sd">            Primary schemas ignore replica priority (used to resolve direct access replica, which could be not with top priority set)</span>
<span class="sd">            :param fspec: input `FileSpec` objects</span>
<span class="sd">            :param allowed_schemas: list of allowed schemas or any if None</span>
<span class="sd">            :return: dict(surl, ddmendpoint, pfn, domain) or None if replica not found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fspec</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;resolve_replica() received no fspec.replicas&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="n">allowed_schemas</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">primary_replica</span><span class="p">,</span> <span class="n">replica</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># group by ddmendpoint to look up related surl/srm value</span>
        <span class="n">replicas</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">rinfo</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>

            <span class="n">replicas</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rinfo</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rinfo</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rinfo</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">domain</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">primary_schemas</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">primary_replica</span><span class="p">:</span>  <span class="c1"># look up primary schemas if requested</span>
                <span class="n">primary_replica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preferred_replica</span><span class="p">([</span><span class="n">rinfo</span><span class="p">],</span> <span class="n">primary_schemas</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replica</span><span class="p">:</span>
                <span class="n">replica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preferred_replica</span><span class="p">([</span><span class="n">rinfo</span><span class="p">],</span> <span class="n">allowed_schemas</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">replica</span> <span class="ow">and</span> <span class="n">primary_replica</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">replica</span> <span class="o">=</span> <span class="n">primary_replica</span> <span class="ow">or</span> <span class="n">replica</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">replica</span><span class="p">:</span>  <span class="c1"># replica not found</span>
            <span class="n">schemas</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_schemas</span><span class="p">)</span>
            <span class="n">pschemas</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span> <span class="k">if</span> <span class="n">primary_schemas</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">primary_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">primary_schemas</span> <span class="ow">or</span> <span class="p">[])</span>

            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Failed to find replica for file=</span><span class="si">%s</span><span class="s1">, domain=</span><span class="si">%s</span><span class="s1">, allowed_schemas=</span><span class="si">%s</span><span class="s1">, pschemas=</span><span class="si">%s</span><span class="s1">, fspec=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">schemas</span><span class="p">,</span> <span class="n">pschemas</span><span class="p">,</span> <span class="n">fspec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;resolve_replica: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># prefer SRM protocol for surl -- to be verified, can it be deprecated?</span>
        <span class="n">rse_replicas</span> <span class="o">=</span> <span class="n">replicas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">replica</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">],</span> <span class="p">[])</span>
        <span class="n">surl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preferred_replica</span><span class="p">(</span><span class="n">rse_replicas</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;srm&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">rse_replicas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[stage-in] surl (srm replica) from Rucio: pfn=</span><span class="si">%s</span><span class="s2">, ddmendpoint=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">surl</span><span class="p">[</span><span class="s1">&#39;pfn&#39;</span><span class="p">],</span> <span class="n">surl</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;surl&#39;</span><span class="p">:</span> <span class="n">surl</span><span class="p">[</span><span class="s1">&#39;pfn&#39;</span><span class="p">],</span> <span class="s1">&#39;ddmendpoint&#39;</span><span class="p">:</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">],</span> <span class="s1">&#39;pfn&#39;</span><span class="p">:</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;pfn&#39;</span><span class="p">],</span> <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]}</span></div>

<div class="viewcode-block" id="StageInClient.get_direct_access_variables"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageInClient.get_direct_access_variables">[docs]</a>    <span class="k">def</span> <span class="nf">get_direct_access_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the direct access settings for the PQ.</span>

<span class="sd">        :param job: job object.</span>
<span class="sd">        :return: allow_direct_access (bool), direct_access_type (string).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allow_direct_access</span><span class="p">,</span> <span class="n">direct_access_type</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">:</span>  <span class="c1"># infosys is initialized</span>
            <span class="n">allow_direct_access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">direct_access_lan</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">direct_access_wan</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">direct_access_lan</span><span class="p">:</span>
                <span class="n">direct_access_type</span> <span class="o">=</span> <span class="s1">&#39;LAN&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">direct_access_wan</span><span class="p">:</span>
                <span class="n">direct_access_type</span> <span class="o">=</span> <span class="s1">&#39;WAN&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;infosys.queuedata is not initialized: direct access mode will be DISABLED by default&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">transfertype</span> <span class="o">!=</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>  <span class="c1"># task forbids direct access</span>
            <span class="n">allow_direct_access</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;switched off direct access mode for production job since transfertype=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">transfertype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">allow_direct_access</span><span class="p">,</span> <span class="n">direct_access_type</span></div>

    <span class="c1">#def set_accessmodes_for_direct_access(self, files, direct_access_type):  ## TO BE DEPRECATED (anisyonk)</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Update the FileSpec accessmodes for direct access and sort the files to get candidates for remote_io coming</span>
    <span class="c1">#    first in order to exclude them from checking of available space for stage-in.</span>
    <span class="c1">#</span>
    <span class="c1">#    :param files: FileSpec objects.</span>
    <span class="c1">#    :param direct_access_type: type of direct access (LAN or WAN) (string).</span>
    <span class="c1">#    :return:</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#    # sort the files</span>
    <span class="c1">#    files = sorted(files, key=lambda x: x.is_directaccess(ensure_replica=False), reverse=True)</span>
    <span class="c1">#</span>
    <span class="c1">#    # populate allowremoteinputs for each FileSpec object</span>
    <span class="c1">#    for fdata in files:</span>
    <span class="c1">#        is_directaccess = fdata.is_directaccess(ensure_replica=False)</span>
    <span class="c1">#        if is_directaccess and direct_access_type == &#39;WAN&#39;:  ## is it the same for ES workflow ?? -- test and verify/FIXME LATER</span>
    <span class="c1">#            fdata.allowremoteinputs = True</span>
    <span class="c1">#        self.logger.info(&quot;check direct access for lfn=%s: allow_direct_access=true, fdata.is_directaccess()=%s =&gt;&quot;</span>
    <span class="c1">#                         &quot; is_directaccess=%s, allowremoteinputs=%s&quot; % (fdata.lfn,</span>
    <span class="c1">#                                                                        fdata.is_directaccess(ensure_replica=False),</span>
    <span class="c1">#                                                                        is_directaccess, fdata.allowremoteinputs))</span>
    <span class="c1">#        # must update accessmode for user jobs (it is only set already for production jobs)</span>
    <span class="c1">#        if fdata.accessmode != &#39;direct&#39; and is_directaccess and fdata.accessmode != &#39;copy&#39;:</span>
    <span class="c1">#            fdata.accessmode = &#39;direct&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#        # reset accessmode if direct access is not to be used</span>
    <span class="c1">#        if fdata.accessmode == &#39;direct&#39; and not is_directaccess:</span>
    <span class="c1">#            fdata.accessmode = &#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#        self.logger.info(&#39;accessmode for LFN=%s: %s (is_directaccess=%s)&#39; % (fdata.lfn, fdata.accessmode, is_directaccess))</span>

<div class="viewcode-block" id="StageInClient.transfer_files"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageInClient.transfer_files">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copytool</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">activity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically stage in files using the selected copy tool module.</span>

<span class="sd">        :param copytool: copytool module</span>
<span class="sd">        :param files: list of `FileSpec` objects</span>
<span class="sd">        :param kwargs: extra kwargs to be passed to copytool transfer handler</span>

<span class="sd">        :return: list of processed `FileSpec` objects</span>
<span class="sd">        :raise: PilotException in case of controlled error</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;require_replicas&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replicas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># look up replicas only once</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_replicas</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">use_vp</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;use_vp&#39;</span><span class="p">])</span>

            <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;allowed_schemas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">:</span>
                <span class="n">copytool_name</span> <span class="o">=</span> <span class="n">copytool</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">resolve_allowed_schemas</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">copytool_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">allowed_schemas</span>

            <span class="c1"># overwrite allowed_schemas for VP jobs</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;use_vp&#39;</span><span class="p">]:</span>
                <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;overwrote allowed_schemas for VP job: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">allowed_schemas</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">resolve_replica</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;resolve_replica&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">resolve_replica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_replica</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">resolve_replica</span><span class="p">)</span> <span class="k">else</span> <span class="n">resolve_replica</span>

                <span class="n">replica</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># process direct access logic  ## TODO move to upper level, should not be dependent on copytool (anisyonk)</span>
                <span class="c1"># check local replicas first</span>
                <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_lan</span><span class="p">:</span>
                    <span class="c1"># prepare schemas which will be used to look up first the replicas allowed for direct access mode</span>
                    <span class="n">primary_schemas</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_localinput_allowed_schemas</span> <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">direct_access_lan</span> <span class="ow">and</span>
                                       <span class="n">fspec</span><span class="o">.</span><span class="n">is_directaccess</span><span class="p">(</span><span class="n">ensure_replica</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">replica</span> <span class="o">=</span> <span class="n">resolve_replica</span><span class="p">(</span><span class="n">fspec</span><span class="p">,</span> <span class="n">primary_schemas</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;lan&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[stage-in] LAN access is DISABLED for lfn=</span><span class="si">%s</span><span class="s2"> (fspec.allow_lan=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_lan</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">replica</span> <span class="ow">and</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_lan</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[stage-in] No LAN replica found for lfn=</span><span class="si">%s</span><span class="s2">, primary_schemas=</span><span class="si">%s</span><span class="s2">, allowed_schemas=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">primary_schemas</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">))</span>

                <span class="c1"># check remote replicas</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">replica</span> <span class="ow">and</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_wan</span><span class="p">:</span>
                    <span class="c1"># prepare schemas which will be used to look up first the replicas allowed for direct access mode</span>
                    <span class="n">primary_schemas</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_remoteinput_allowed_schemas</span> <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">direct_access_wan</span> <span class="ow">and</span>
                                       <span class="n">fspec</span><span class="o">.</span><span class="n">is_directaccess</span><span class="p">(</span><span class="n">ensure_replica</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">xschemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteinput_allowed_schemas</span>
                    <span class="n">allowed_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">allowed_schemas</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">xschemas</span><span class="p">]</span> <span class="k">if</span> <span class="n">allowed_schemas</span> <span class="k">else</span> <span class="n">xschemas</span>
                    <span class="n">replica</span> <span class="o">=</span> <span class="n">resolve_replica</span><span class="p">(</span><span class="n">fspec</span><span class="p">,</span> <span class="n">primary_schemas</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;wan&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">replica</span> <span class="ow">and</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_wan</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[stage-in] No WAN replica found for lfn=</span><span class="si">%s</span><span class="s2">, primary_schemas=</span><span class="si">%s</span><span class="s2">, allowed_schemas=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">primary_schemas</span><span class="p">,</span> <span class="n">allowed_schemas</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">replica</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReplicasNotFound</span><span class="p">(</span><span class="s1">&#39;No replica found for lfn=</span><span class="si">%s</span><span class="s1"> (allow_lan=</span><span class="si">%s</span><span class="s1">, allow_wan=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_lan</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">allow_wan</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pfn&#39;</span><span class="p">):</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">turl</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;pfn&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;surl&#39;</span><span class="p">):</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">surl</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;surl&#39;</span><span class="p">]</span>  <span class="c1"># TO BE CLARIFIED if it&#39;s still used and need</span>
                <span class="k">if</span> <span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">):</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;ddmendpoint&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">replica</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">):</span>
                    <span class="n">fspec</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">replica</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[stage-in] found replica to be used for lfn=</span><span class="si">%s</span><span class="s2">: ddmendpoint=</span><span class="si">%s</span><span class="s2">, pfn=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">turl</span><span class="p">))</span>

        <span class="c1"># prepare files (resolve protocol/transfer url)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;require_input_protocols&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_protocols</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">copytool</span><span class="p">,</span> <span class="n">activity</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;input_dir&#39;</span><span class="p">])</span>

        <span class="c1"># mark direct access files with status=remote_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_for_direct_access</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workdir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="c1"># get remain files that need to be transferred by copytool</span>
        <span class="n">remain_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="s1">&#39;remote_io&#39;</span><span class="p">,</span> <span class="s1">&#39;transferred&#39;</span><span class="p">,</span> <span class="s1">&#39;no_transfer&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">remain_files</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">files</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">copytool</span><span class="o">.</span><span class="n">is_valid_for_copy_in</span><span class="p">(</span><span class="n">remain_files</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;input is not valid for transfers using copytool=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">copytool</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;input: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remain_files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clientState</span><span class="o">=</span><span class="s1">&#39;NO_REPLICA&#39;</span><span class="p">,</span> <span class="n">stateReason</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s1">&#39;invalid input data for transfer operation&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;copytools&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">copytools</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ddmconf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">resolve_storage_data</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activity</span>

        <span class="c1"># verify file sizes and available space for stage-in</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">maxinputsize</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_availablespace</span><span class="p">(</span><span class="n">remain_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;skipping input file size check since maxinputsize=-1&#39;</span><span class="p">)</span>
        <span class="n">show_memory_usage</span><span class="p">()</span>

        <span class="c1"># add the trace report</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;trace_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ready to transfer (stage-in) files: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remain_files</span><span class="p">)</span>

        <span class="c1"># use bulk downloads if necessary</span>
        <span class="c1"># if kwargs[&#39;use_bulk_transfer&#39;]</span>
        <span class="c1"># return copytool.copy_in_bulk(remain_files, **kwargs)</span>
        <span class="k">return</span> <span class="n">copytool</span><span class="o">.</span><span class="n">copy_in</span><span class="p">(</span><span class="n">remain_files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="StageInClient.set_status_for_direct_access"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageInClient.set_status_for_direct_access">[docs]</a>    <span class="k">def</span> <span class="nf">set_status_for_direct_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the FileSpec status with &#39;remote_io&#39; for direct access mode.</span>
<span class="sd">        Should be called only once since the function sends traces</span>

<span class="sd">        :param files: list of FileSpec objects.</span>
<span class="sd">        :param workdir: work directory (string).</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">direct_lan</span> <span class="o">=</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;lan&#39;</span> <span class="ow">and</span> <span class="n">fspec</span><span class="o">.</span><span class="n">direct_access_lan</span> <span class="ow">and</span>
                          <span class="n">fspec</span><span class="o">.</span><span class="n">is_directaccess</span><span class="p">(</span><span class="n">ensure_replica</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allowed_replica_schemas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_localinput_allowed_schemas</span><span class="p">))</span>
            <span class="n">direct_wan</span> <span class="o">=</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;wan&#39;</span> <span class="ow">and</span> <span class="n">fspec</span><span class="o">.</span><span class="n">direct_access_wan</span> <span class="ow">and</span>
                          <span class="n">fspec</span><span class="o">.</span><span class="n">is_directaccess</span><span class="p">(</span><span class="n">ensure_replica</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allowed_replica_schemas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteinput_allowed_schemas</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">direct_lan</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">direct_wan</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;direct lan/wan transfer will not be used for lfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;lfn=</span><span class="si">%s</span><span class="s1">, direct_lan=</span><span class="si">%s</span><span class="s1">, direct_wan=</span><span class="si">%s</span><span class="s1">, direct_access_lan=</span><span class="si">%s</span><span class="s1">, direct_access_wan=</span><span class="si">%s</span><span class="s1">, &#39;</span>
                              <span class="s1">&#39;direct_localinput_allowed_schemas=</span><span class="si">%s</span><span class="s1">, remoteinput_allowed_schemas=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">direct_lan</span><span class="p">,</span> <span class="n">direct_wan</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">direct_access_lan</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">direct_access_wan</span><span class="p">,</span>
                               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_localinput_allowed_schemas</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteinput_allowed_schemas</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">direct_lan</span> <span class="ow">or</span> <span class="n">direct_wan</span><span class="p">:</span>
                <span class="n">fspec</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fspec</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;remote_io&#39;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;stage-in: direct access (remote i/o) will be used for lfn=</span><span class="si">%s</span><span class="s1"> (direct_lan=</span><span class="si">%s</span><span class="s1">, direct_wan=</span><span class="si">%s</span><span class="s1">), turl=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">direct_lan</span><span class="p">,</span> <span class="n">direct_wan</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">turl</span><span class="p">))</span>

                <span class="c1"># send trace</span>
                <span class="n">localsite</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RUCIO_LOCAL_SITE_ID&#39;</span><span class="p">)</span>
                <span class="n">localsite</span> <span class="o">=</span> <span class="n">localsite</span> <span class="ow">or</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">localSite</span><span class="o">=</span><span class="n">localsite</span><span class="p">,</span> <span class="n">remoteSite</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">,</span> <span class="n">filesize</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">filesize</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">guid</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">guid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">turl</span><span class="p">,</span> <span class="n">clientState</span><span class="o">=</span><span class="s1">&#39;FOUND_ROOT&#39;</span><span class="p">,</span> <span class="n">stateReason</span><span class="o">=</span><span class="s1">&#39;direct_access&#39;</span><span class="p">)</span>

                <span class="c1"># do not send the trace report at this point if remote file verification is to be done</span>
                <span class="c1"># note also that we can&#39;t verify the files at this point since root will not be available from inside</span>
                <span class="c1"># the rucio container</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">remotefileverification_log</span><span class="p">:</span>
                    <span class="c1"># store the trace report for later use (the trace report class inherits from dict, so just write it as JSON)</span>
                    <span class="c1"># outside of the container, it will be available in the normal work dir</span>
                    <span class="c1"># use the normal work dir if we are not in a container</span>
                    <span class="n">_workdir</span> <span class="o">=</span> <span class="n">workdir</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">base_trace_report</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_workdir</span><span class="p">):</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/srv&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">base_trace_report</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;writing base trace report to: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                        <span class="n">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">send</span><span class="p">()</span></div>

<div class="viewcode-block" id="StageInClient.check_availablespace"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageInClient.check_availablespace">[docs]</a>    <span class="k">def</span> <span class="nf">check_availablespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that enough local space is available to stage in and run the job</span>

<span class="sd">        :param files: list of FileSpec objects.</span>
<span class="sd">        :raise: PilotException in case of not enough space or total input size too large</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;lfn=</span><span class="si">%s</span><span class="s1"> filesize=</span><span class="si">%d</span><span class="s1"> accessmode=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">accessmode</span><span class="p">))</span>

        <span class="n">maxinputsize</span> <span class="o">=</span> <span class="n">convert_mb_to_b</span><span class="p">(</span><span class="n">get_maximum_input_sizes</span><span class="p">())</span>
        <span class="n">totalsize</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># verify total filesize</span>
        <span class="k">if</span> <span class="n">maxinputsize</span> <span class="ow">and</span> <span class="n">totalsize</span> <span class="o">&gt;</span> <span class="n">maxinputsize</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;too many/too large input files (</span><span class="si">%s</span><span class="s2">). total file size=</span><span class="si">%s</span><span class="s2"> B &gt; maxinputsize=</span><span class="si">%s</span><span class="s2"> B&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">totalsize</span><span class="p">,</span> <span class="n">maxinputsize</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SizeTooLarge</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;total input file size=</span><span class="si">%s</span><span class="s2"> B within allowed limit=</span><span class="si">%s</span><span class="s2"> B (zero value means unlimited)&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">totalsize</span><span class="p">,</span> <span class="n">maxinputsize</span><span class="p">))</span>

        <span class="c1"># get available space</span>
        <span class="n">available_space</span> <span class="o">=</span> <span class="n">convert_mb_to_b</span><span class="p">(</span><span class="n">get_local_disk_space</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;locally available space: </span><span class="si">%d</span><span class="s2"> B&quot;</span> <span class="o">%</span> <span class="n">available_space</span><span class="p">)</span>

        <span class="c1"># are we within the limit?</span>
        <span class="k">if</span> <span class="n">totalsize</span> <span class="o">&gt;</span> <span class="n">available_space</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;not enough local space for staging input files and run the job (need </span><span class="si">%d</span><span class="s2"> B, but only have </span><span class="si">%d</span><span class="s2"> B)&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">totalsize</span><span class="p">,</span> <span class="n">available_space</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoLocalSpace</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StageOutClient"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageOutClient">[docs]</a><span class="k">class</span> <span class="nc">StageOutClient</span><span class="p">(</span><span class="n">StagingClient</span><span class="p">):</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stage-out&quot;</span>

<div class="viewcode-block" id="StageOutClient.prepare_destinations"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageOutClient.prepare_destinations">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_destinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">activities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Resolve destination RSE (filespec.ddmendpoint) for each entry from `files` according to requested `activities`</span>
<span class="sd">            Apply Pilot-side logic to choose proper destination</span>
<span class="sd">            :param files: list of FileSpec objects to be processed</span>
<span class="sd">            :param activities: ordered list of activities to be used to resolve astorages</span>
<span class="sd">            :return: updated fspec entries</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">:</span>  <span class="c1"># infosys is not initialized: not able to fix destination if need, nothing to do</span>
            <span class="k">return</span> <span class="n">files</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activities</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>  <span class="c1"># Python 2 # noqa: F821</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="p">[</span><span class="n">activities</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activities</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># Python 3</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="p">[</span><span class="n">activities</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">activities</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s2">&quot;Failed to resolve destination: passed empty activity list. Internal error.&quot;</span><span class="p">,</span>
                                 <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">INTERNALPILOTPROBLEM</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;INTERNAL_ERROR&#39;</span><span class="p">)</span>

        <span class="n">astorages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">astorages</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">storages</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">activity</span> <span class="o">=</span> <span class="n">activities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
            <span class="n">storages</span> <span class="o">=</span> <span class="n">astorages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">storages</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">storages</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mv&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">copytools</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">files</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s2">&quot;Failed to resolve destination: no associated storages defined for activity=</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">activities</span><span class="p">)),</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">NOSTORAGE</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;NO_ASTORAGES_DEFINED&#39;</span><span class="p">)</span>

        <span class="c1"># take the fist choice for now, extend the logic later if need</span>
        <span class="n">ddm</span> <span class="o">=</span> <span class="n">storages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[prepare_destinations][</span><span class="si">%s</span><span class="s2">]: allowed (local) destinations: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">storages</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[prepare_destinations][</span><span class="si">%s</span><span class="s2">]: resolved default destination ddm=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">ddm</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">:</span>  <span class="c1"># no preferences =&gt; use default destination</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[prepare_destinations][</span><span class="si">%s</span><span class="s2">]: fspec.ddmendpoint is not set for lfn=</span><span class="si">%s</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot; .. will use default ddm=</span><span class="si">%s</span><span class="s2"> as (local) destination&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">ddm</span><span class="p">))</span>
                <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="o">=</span> <span class="n">ddm</span>
            <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storages</span><span class="p">:</span>  <span class="c1"># fspec.ddmendpoint is not in associated storages =&gt; assume it as final (non local) alternative destination</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[prepare_destinations][</span><span class="si">%s</span><span class="s2">]: Requested fspec.ddmendpoint=</span><span class="si">%s</span><span class="s2"> is not in the list of allowed (local) destinations&quot;</span>
                                 <span class="s2">&quot; .. will consider default ddm=</span><span class="si">%s</span><span class="s2"> for transfer and tag </span><span class="si">%s</span><span class="s2"> as alt. location&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">,</span> <span class="n">ddm</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">))</span>
                <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span> <span class="o">=</span> <span class="n">ddm</span>
                <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint_alt</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ddmendpoint</span>  <span class="c1"># consider me later</span>

        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="StageOutClient.get_path"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageOutClient.get_path">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">lfn</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;rucio&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct a partial Rucio PFN using the scope and the LFN</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># &lt;prefix=rucio&gt;/&lt;scope&gt;/md5(&lt;scope&gt;:&lt;lfn&gt;)[0:2]/md5(&lt;scope:lfn&gt;)[2:4]/&lt;lfn&gt;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">lfn</span><span class="p">)</span>
        <span class="n">hash_hex</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># Python 2/3</span>

        <span class="c1">#paths = [prefix] + scope.split(&#39;.&#39;) + [hash_hex[0:2], hash_hex[2:4], lfn]</span>
        <span class="c1"># exclude prefix from the path: this should be properly considered in protocol/AGIS for today</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">hash_hex</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">hash_hex</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">lfn</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span>  <span class="c1"># remove empty parts to avoid double /-chars, Python 2</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">_f</span><span class="p">]</span>  <span class="c1"># remove empty parts to avoid double /-chars, Python 3</span>

        <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span></div>

<div class="viewcode-block" id="StageOutClient.resolve_surl"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageOutClient.resolve_surl">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_surl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspec</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">ddmconf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get final destination SURL for file to be transferred</span>
<span class="sd">            Can be customized at the level of specific copytool</span>
<span class="sd">            :param protocol: suggested protocol</span>
<span class="sd">            :param ddmconf: full ddmconf data</span>
<span class="sd">            :param activity: ordered list of preferred activity names to resolve SE protocols</span>
<span class="sd">            :return: dict with keys (&#39;pfn&#39;, &#39;ddmendpoint&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">local_dir</span><span class="p">:</span>
            <span class="c1"># consider only deterministic sites (output destination) - unless local input/output</span>
            <span class="n">ddm</span> <span class="o">=</span> <span class="n">ddmconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s1">&#39;Failed to resolve ddmendpoint by name=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">)</span>

            <span class="c1"># path = protocol.get(&#39;path&#39;, &#39;&#39;).rstrip(&#39;/&#39;)</span>
            <span class="c1"># if not (ddm.is_deterministic or (path and path.endswith(&#39;/rucio&#39;))):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddm</span><span class="o">.</span><span class="n">is_deterministic</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s1">&#39;resolve_surl(): Failed to construct SURL for non deterministic ddm=</span><span class="si">%s</span><span class="s1">: &#39;</span>
                                     <span class="s1">&#39;NOT IMPLEMENTED&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">NONDETERMINISTICDDM</span><span class="p">)</span>

        <span class="n">surl</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;endpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;surl&#39;</span><span class="p">:</span> <span class="n">surl</span><span class="p">}</span></div>

<div class="viewcode-block" id="StageOutClient.transfer_files"><a class="viewcode-back" href="../../../components/api/data.html#pilot.api.data.StageOutClient.transfer_files">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copytool</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">activity</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Automatically stage out files using the selected copy tool module.</span>

<span class="sd">            :param copytool: copytool module</span>
<span class="sd">            :param files: list of `FileSpec` objects</span>
<span class="sd">            :param activity: ordered list of preferred activity names to resolve SE protocols</span>
<span class="sd">            :param kwargs: extra kwargs to be passed to copytool transfer handler</span>

<span class="sd">            :return: the output of the copytool transfer operation</span>
<span class="sd">            :raise: PilotException in case of controlled error</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if files exist before actual processing</span>
        <span class="c1"># populate filesize if need, calc checksum</span>
        <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">:</span>  <span class="c1"># ensure that output destination is properly set</span>
                <span class="k">if</span> <span class="s1">&#39;mv&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">copytools</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No output RSE defined for file=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">NOSTORAGE</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;NO_OUTPUTSTORAGE_DEFINED&#39;</span><span class="p">)</span>

            <span class="n">pfn</span> <span class="o">=</span> <span class="n">fspec</span><span class="o">.</span><span class="n">surl</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fspec</span><span class="p">,</span> <span class="s1">&#39;pfn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workdir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error: output pfn file does not exist: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pfn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clientState</span><span class="o">=</span><span class="s1">&#39;MISSINGOUTPUTFILE&#39;</span><span class="p">,</span> <span class="n">stateReason</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">MISSINGOUTPUTFILE</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;FILE_INFO_FAIL&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fspec</span><span class="o">.</span><span class="n">filesize</span><span class="p">:</span>
                <span class="n">fspec</span><span class="o">.</span><span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fspec</span><span class="o">.</span><span class="n">filesize</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;output file has size zero: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">ZEROFILESIZE</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;ZERO_FILE_SIZE&quot;</span><span class="p">)</span>

            <span class="n">fspec</span><span class="o">.</span><span class="n">surl</span> <span class="o">=</span> <span class="n">pfn</span>
            <span class="n">fspec</span><span class="o">.</span><span class="n">activity</span> <span class="o">=</span> <span class="n">activity</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fspec</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adler32&#39;</span><span class="p">):</span>
                <span class="n">fspec</span><span class="o">.</span><span class="n">checksum</span><span class="p">[</span><span class="s1">&#39;adler32&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_checksum</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span>

        <span class="c1"># prepare files (resolve protocol/transfer url)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">copytool</span><span class="p">,</span> <span class="s1">&#39;require_protocols&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_protocols</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">copytool</span><span class="p">,</span> <span class="n">activity</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">copytool</span><span class="o">.</span><span class="n">is_valid_for_copy_out</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Input is not valid for transfers using copytool=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">copytool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Input: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">files</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="s1">&#39;Invalid input for transfer operation&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ready to transfer (stage-out) files: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">files</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;copytools&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">copytools</span>

            <span class="c1"># some copytools will need to know endpoint specifics (e.g. the space token) stored in ddmconf, add it</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ddmconf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">resolve_storage_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;nothing to stage-out - an internal Pilot error has occurred&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ErrorCodes</span><span class="o">.</span><span class="n">INTERNALPILOTPROBLEM</span><span class="p">)</span>

        <span class="c1"># add the trace report</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;trace_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_report</span>

        <span class="k">return</span> <span class="n">copytool</span><span class="o">.</span><span class="n">copy_out</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>

<span class="c1">#class StageInClientAsync(object):</span>
<span class="c1">#</span>
<span class="c1">#    def __init__(self, site):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def queue(self, files):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def is_transferring(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def start(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def finish(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def status(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#class StageOutClientAsync(object):</span>
<span class="c1">#</span>
<span class="c1">#    def __init__(self, site):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def queue(self, files):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def is_transferring(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def start(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def finish(self):</span>
<span class="c1">#        raise NotImplementedError</span>
<span class="c1">#</span>
<span class="c1">#    def status(self):</span>
<span class="c1">#        raise NotImplementedError</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Pilot 2</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/index.html">Components</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Paul Nilsson, Mario Lassnig, Daniil Drizhuk, ....
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>