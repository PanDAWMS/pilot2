
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pilot.user.atlas.common &#8212; Pilot 2  documentation</title>
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pilot.user.atlas.common</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># - Paul Nilsson, paul.nilsson@cern.ch, 2017-2021</span>
<span class="c1"># - Wen Guan, wen.guan@cern.ch, 2018</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGTERM</span><span class="p">,</span> <span class="n">SIGUSR1</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>  <span class="c1"># Python 3</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">.container</span> <span class="kn">import</span> <span class="n">create_root_container_command</span>
<span class="kn">from</span> <span class="nn">.dbrelease</span> <span class="kn">import</span> <span class="n">get_dbrelease_version</span><span class="p">,</span> <span class="n">create_dbrelease</span>
<span class="kn">from</span> <span class="nn">.setup</span> <span class="kn">import</span> <span class="n">should_pilot_prepare_setup</span><span class="p">,</span> <span class="n">is_standard_atlas_job</span><span class="p">,</span> <span class="n">get_asetup</span><span class="p">,</span>\
    <span class="n">set_inds</span><span class="p">,</span> <span class="n">get_analysis_trf</span><span class="p">,</span> <span class="n">get_payload_environment_variables</span><span class="p">,</span> <span class="n">replace_lfns_with_turls</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">get_memory_monitor_setup</span><span class="p">,</span> <span class="n">get_network_monitor_setup</span><span class="p">,</span> <span class="n">post_memory_monitor_action</span><span class="p">,</span>\
    <span class="n">get_memory_monitor_summary_filename</span><span class="p">,</span> <span class="n">get_prefetcher_setup</span><span class="p">,</span> <span class="n">get_benchmark_setup</span><span class="p">,</span> <span class="n">get_memory_monitor_output_filename</span><span class="p">,</span>\
    <span class="n">get_metadata_dict_from_txt</span>

<span class="kn">from</span> <span class="nn">pilot.util.auxiliary</span> <span class="kn">import</span> <span class="n">get_resource_name</span><span class="p">,</span> <span class="n">show_memory_usage</span>
<span class="kn">from</span> <span class="nn">pilot.common.errorcodes</span> <span class="kn">import</span> <span class="n">ErrorCodes</span>
<span class="kn">from</span> <span class="nn">pilot.common.exception</span> <span class="kn">import</span> <span class="n">TrfDownloadFailure</span><span class="p">,</span> <span class="n">PilotException</span>
<span class="kn">from</span> <span class="nn">pilot.util.auxiliary</span> <span class="kn">import</span> <span class="n">is_python3</span>
<span class="kn">from</span> <span class="nn">pilot.util.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">pilot.util.constants</span> <span class="kn">import</span> <span class="n">UTILITY_BEFORE_PAYLOAD</span><span class="p">,</span> <span class="n">UTILITY_WITH_PAYLOAD</span><span class="p">,</span> <span class="n">UTILITY_AFTER_PAYLOAD_STARTED</span><span class="p">,</span>\
    <span class="n">UTILITY_AFTER_PAYLOAD</span><span class="p">,</span> <span class="n">UTILITY_AFTER_PAYLOAD_FINISHED</span><span class="p">,</span> <span class="n">UTILITY_AFTER_PAYLOAD_STARTED2</span><span class="p">,</span>\
    <span class="n">UTILITY_BEFORE_STAGEIN</span>
<span class="kn">from</span> <span class="nn">pilot.util.container</span> <span class="kn">import</span> <span class="n">execute</span>
<span class="kn">from</span> <span class="nn">pilot.util.filehandling</span> <span class="kn">import</span> <span class="n">remove</span><span class="p">,</span> <span class="n">get_guid</span><span class="p">,</span> <span class="n">remove_dir_tree</span><span class="p">,</span> <span class="n">read_list</span><span class="p">,</span> <span class="n">remove_core_dumps</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span>\
    <span class="n">copy_pilot_source</span><span class="p">,</span> <span class="n">write_file</span><span class="p">,</span> <span class="n">read_json</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">update_extension</span><span class="p">,</span> <span class="n">get_local_file_size</span><span class="p">,</span> <span class="n">calculate_checksum</span>
<span class="kn">from</span> <span class="nn">pilot.util.tracereport</span> <span class="kn">import</span> <span class="n">TraceReport</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">errors</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="p">()</span>


<div class="viewcode-block" id="sanity_check"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.sanity_check">[docs]</a><span class="k">def</span> <span class="nf">sanity_check</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform an initial sanity check before doing anything else in a given workflow.</span>
<span class="sd">    This function can be used to verify importing of modules that are otherwise used much later, but it is better to abort</span>
<span class="sd">    the pilot if a problem is discovered early.</span>

<span class="sd">    :return: exit code (0 if all is ok, otherwise non-zero exit code).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#try:</span>
    <span class="c1">#    from rucio.client.downloadclient import DownloadClient</span>
    <span class="c1">#    from rucio.client.uploadclient import UploadClient</span>
    <span class="c1">#    # note: must do something with Download/UploadClients or flake8 will complain - but do not instantiate</span>
    <span class="c1">#except Exception as e:</span>
    <span class="c1">#    logger.warning(&#39;sanity check failed: %s&#39; % e)</span>
    <span class="c1">#    exit_code = errors.MIDDLEWAREIMPORTFAILURE</span>

    <span class="k">return</span> <span class="n">exit_code</span></div>


<div class="viewcode-block" id="validate"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.validate">[docs]</a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform user specific payload/job validation.</span>
<span class="sd">    This function will produce a local DBRelease file if necessary (old releases).</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: Boolean (True if validation is successful).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;DBRelease&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;encountered DBRelease info in job parameters - will attempt to create a local DBRelease file&#39;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">get_dbrelease_version</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">create_dbrelease</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

    <span class="c1"># assign error in case of DBRelease handling failure</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">DBRELEASEFAILURE</span><span class="p">)</span>

    <span class="c1"># make sure that any given images actually exist</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;verified that image exists: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;image does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">IMAGENOTFOUND</span><span class="p">)</span>

    <span class="c1"># cleanup job parameters if only copy-to-scratch</span>
    <span class="c1">#if job.only_copy_to_scratch():</span>
    <span class="c1">#    logger.debug(&#39;job.params=%s&#39; % job.jobparams)</span>
    <span class="c1">#    if &#39; --usePFCTurl&#39; in job.jobparams:</span>
    <span class="c1">#        logger.debug(&#39;cleaning up --usePFCTurl from job parameters since all input is copy-to-scratch&#39;)</span>
    <span class="c1">#        job.jobparams = job.jobparams.replace(&#39; --usePFCTurl&#39;, &#39;&#39;)</span>
    <span class="c1">#    if &#39; --directIn&#39; in job.jobparams:</span>
    <span class="c1">#        logger.debug(&#39;cleaning up --directIn from job parameters since all input is copy-to-scratch&#39;)</span>
    <span class="c1">#        job.jobparams = job.jobparams.replace(&#39; --directIn&#39;, &#39;&#39;)</span>

    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="open_remote_files"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.open_remote_files">[docs]</a><span class="k">def</span> <span class="nf">open_remote_files</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that direct i/o files can be opened.</span>

<span class="sd">    :param indata: list of FileSpec.</span>
<span class="sd">    :param workdir: working directory (string).</span>
<span class="sd">    :return: exit code (int), diagnostics (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ec</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">diagnostics</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">not_opened</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># extract direct i/o files from indata (string of comma-separated turls)</span>
    <span class="n">turls</span> <span class="o">=</span> <span class="n">extract_turls</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">turls</span><span class="p">:</span>
        <span class="c1"># execute file open script which will attempt to open each file</span>

        <span class="c1"># copy pilot source into container directory, unless it is already there</span>
        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">copy_pilot_source</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diagnostics</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>

        <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;open_remote_file.py&#39;</span>
        <span class="n">final_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">workdir</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;pilot/scripts&#39;</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PILOT_HOME&#39;</span><span class="p">],</span> <span class="s1">&#39;pilot2&#39;</span><span class="p">),</span> <span class="n">script_path</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">script_path</span><span class="p">)</span>
        <span class="n">full_script_path</span> <span class="o">=</span> <span class="n">d1</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="k">else</span> <span class="n">d2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_script_path</span><span class="p">):</span>
            <span class="c1"># do not set ec since this will be a pilot issue rather than site issue</span>
            <span class="n">diagnostics</span> <span class="o">=</span> <span class="s1">&#39;cannot perform file open test - script path does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">full_script_path</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;tested both path=</span><span class="si">%s</span><span class="s1"> and path=</span><span class="si">%s</span><span class="s1"> (none exists)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">not_opened</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">copy</span><span class="p">(</span><span class="n">full_script_path</span><span class="p">,</span> <span class="n">final_script_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># do not set ec since this will be a pilot issue rather than site issue</span>
            <span class="n">diagnostics</span> <span class="o">=</span> <span class="s1">&#39;cannot perform file open test - pilot source copy failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">not_opened</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># correct the path when containers have been used</span>
            <span class="n">final_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>

            <span class="n">_cmd</span> <span class="o">=</span> <span class="n">get_file_open_command</span><span class="p">(</span><span class="n">final_script_path</span><span class="p">,</span> <span class="n">turls</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">create_root_container_command</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">)</span>

            <span class="n">show_memory_usage</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;*** executing file open verification script:</span><span class="se">\n\n\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">exit_code</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">usecontainer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">remotefileverification_log</span><span class="p">:</span>
                <span class="n">write_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">remotefileverification_log</span><span class="p">),</span> <span class="n">stdout</span> <span class="o">+</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">show_memory_usage</span><span class="p">()</span>

            <span class="c1"># error handling</span>
            <span class="k">if</span> <span class="n">exit_code</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;script </span><span class="si">%s</span><span class="s1"> finished with ec=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dictionary_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">remotefileverification_dictionary</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dictionary_path</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;file does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dictionary_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_dictionary</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">dictionary_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_dictionary</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;could not read dictionary from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dictionary_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">not_opened</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">for</span> <span class="n">turl</span> <span class="ow">in</span> <span class="n">file_dictionary</span><span class="p">:</span>
                            <span class="n">opened</span> <span class="o">=</span> <span class="n">file_dictionary</span><span class="p">[</span><span class="n">turl</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;turl could be opened: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">turl</span><span class="p">)</span> <span class="k">if</span> <span class="n">opened</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;turl could not be opened: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">turl</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">opened</span><span class="p">:</span>
                                <span class="n">not_opened</span> <span class="o">+=</span> <span class="n">turl</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">not_opened</span> <span class="k">else</span> <span class="s2">&quot;,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">turl</span>
                        <span class="k">if</span> <span class="n">not_opened</span><span class="p">:</span>
                            <span class="n">ec</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">REMOTEFILECOULDNOTBEOPENED</span>
                            <span class="n">diagnostics</span> <span class="o">=</span> <span class="s2">&quot;turl not opened:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">not_opened</span> <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">not_opened</span> <span class="k">else</span> <span class="s2">&quot;turls not opened:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">not_opened</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;nothing to verify (for remote files)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">not_opened</span></div>


<div class="viewcode-block" id="get_file_open_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_file_open_command">[docs]</a><span class="k">def</span> <span class="nf">get_file_open_command</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">turls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param script_path: path to script (string).</span>
<span class="sd">    :return: comma-separated list of turls (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> --turls=</span><span class="si">%s</span><span class="s2"> -w </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">turls</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script_path</span><span class="p">))</span></div>


<div class="viewcode-block" id="extract_turls"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.extract_turls">[docs]</a><span class="k">def</span> <span class="nf">extract_turls</span><span class="p">(</span><span class="n">indata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract TURLs from indata for direct i/o files.</span>

<span class="sd">    :param indata: list of FileSpec.</span>
<span class="sd">    :return: comma-separated list of turls (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">turls</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">indata</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;remote_io&#39;</span><span class="p">:</span>
            <span class="n">turls</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">turl</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">turls</span> <span class="k">else</span> <span class="s2">&quot;,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">turl</span>

    <span class="k">return</span> <span class="n">turls</span></div>


<div class="viewcode-block" id="process_remote_file_traces"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.process_remote_file_traces">[docs]</a><span class="k">def</span> <span class="nf">process_remote_file_traces</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">not_opened_turls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Report traces for remote files.</span>
<span class="sd">    The function reads back the base trace report (common part of all traces) and updates it per file before reporting</span>
<span class="sd">    it to the Rucio server.</span>

<span class="sd">    :param path: path to base trace report (string).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param not_opened_turls: list of turls that could not be opened (list).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">base_trace_report</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PilotException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to open base trace report (cannot send trace reports): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_trace_report</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to read back base trace report (cannot send trace reports)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># update and send the trace info</span>
            <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">indata</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;remote_io&#39;</span><span class="p">:</span>
                    <span class="n">base_trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">turl</span><span class="p">)</span>
                    <span class="n">base_trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">remoteSite</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">,</span> <span class="n">filesize</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">filesize</span><span class="p">)</span>
                    <span class="n">base_trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">guid</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">guid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="n">base_trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">fspec</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">turl</span> <span class="ow">in</span> <span class="n">not_opened_turls</span><span class="p">:</span>
                        <span class="n">base_trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clientState</span><span class="o">=</span><span class="s1">&#39;FAILED_REMOTE_OPEN&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">base_trace_report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clientState</span><span class="o">=</span><span class="s1">&#39;FOUND_ROOT&#39;</span><span class="p">)</span>

                    <span class="c1"># copy the base trace report (only a dictionary) into a real trace report object</span>
                    <span class="n">trace_report</span> <span class="o">=</span> <span class="n">TraceReport</span><span class="p">(</span><span class="o">**</span><span class="n">base_trace_report</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">trace_report</span><span class="p">:</span>
                        <span class="n">trace_report</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to create trace report for turl=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">turl</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_payload_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_payload_command">[docs]</a><span class="k">def</span> <span class="nf">get_payload_command</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the full command for executing the payload, including the sourcing of all setup files and setting of</span>
<span class="sd">    environment variables.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :raises PilotException: TrfDownloadFailure.</span>
<span class="sd">    :return: command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">show_memory_usage</span><span class="p">()</span>

    <span class="c1"># Should the pilot do the setup or does jobPars already contain the information?</span>
    <span class="n">preparesetup</span> <span class="o">=</span> <span class="n">should_pilot_prepare_setup</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">noexecstrcnv</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>

    <span class="c1"># Get the platform value</span>
    <span class="c1"># platform = job.infosys.queuedata.platform</span>

    <span class="c1"># Is it a user job or not?</span>
    <span class="n">userjob</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot is running a user analysis job&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">userjob</span> <span class="k">else</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot is running a production job&#39;</span><span class="p">)</span>

    <span class="n">resource_name</span> <span class="o">=</span> <span class="n">get_resource_name</span><span class="p">()</span>  <span class="c1"># &#39;grid&#39; if no hpc_resource is set</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.user.atlas.resource.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resource_name</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">resource_name</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 3, -1 -&gt; 0</span>

    <span class="c1"># get the general setup command and then verify it if required</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get_setup_command</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">preparesetup</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">verify_setup_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ec</span><span class="p">)</span>

    <span class="c1"># make sure that remote file can be opened before executing payload</span>
    <span class="n">catchall</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">catchall</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">catchall</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">remotefileverification_log</span> <span class="ow">and</span> <span class="s1">&#39;remoteio_test=false&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">catchall</span><span class="p">:</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diagnostics</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">not_opened_turls</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">not_opened_turls</span> <span class="o">=</span> <span class="n">open_remote_files</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">indata</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;caught exception: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># read back the base trace report</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">base_trace_report</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;base trace report does not exist (</span><span class="si">%s</span><span class="s1">) - input file traces should already have been sent&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">process_remote_file_traces</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">not_opened_turls</span><span class="p">)</span>

            <span class="c1"># fail the job if the remote files could not be verified</span>
            <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">PilotException</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no remote file open verification&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_standard_atlas_job</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">swrelease</span><span class="p">):</span>

        <span class="c1"># Normal setup (production and user jobs)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;preparing normal production/analysis job setup command&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">get_normal_payload_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">preparesetup</span><span class="p">,</span> <span class="n">userjob</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Generic, non-ATLAS specific jobs, or at least a job with undefined swRelease</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;generic job (non-ATLAS specific or with undefined swRelease)&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">get_generic_payload_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">preparesetup</span><span class="p">,</span> <span class="n">userjob</span><span class="p">)</span>

    <span class="c1"># add any missing trailing ;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;; &#39;</span>

    <span class="c1"># only if not using a user container</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_SITENAME&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">get_payload_environment_variables</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">taskid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">attemptnr</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">processingtype</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">userjob</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">+</span> <span class="n">cmd</span>

    <span class="c1"># prepend PanDA job id in case it is not there already (e.g. runcontainer jobs)</span>
    <span class="k">if</span> <span class="s1">&#39;export PandaID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;export PandaID=</span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span> <span class="o">+</span> <span class="n">cmd</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;;&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">)</span>

    <span class="c1"># For direct access in prod jobs, we need to substitute the input file names with the corresponding TURLs</span>
    <span class="c1"># get relevant file transfer info</span>
    <span class="c1">#use_copy_tool, use_direct_access, use_pfc_turl = get_file_transfer_info(job)</span>
    <span class="c1">#if not userjob and use_direct_access and job.transfertype == &#39;direct&#39;:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">userjob</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_build_job</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">has_remoteio</span><span class="p">():</span>  <span class="c1">## ported from old logic</span>
        <span class="c1">## ported from old logic but still it looks strange (anisyonk)</span>
        <span class="c1">## the &quot;PoolFileCatalog.xml&quot; should already contains proper TURLs values as it created by create_input_file_metadata()</span>
        <span class="c1">## if the case is just to patch `writetofile` file, than logic should be cleaned and decoupled</span>
        <span class="c1">## anyway, instead of parsing the file, it&#39;s much more easy to generate properly `writetofile` content from the beginning with TURL data</span>
        <span class="n">lfns</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_lfns_and_guids</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">replace_lfns_with_turls</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;PoolFileCatalog.xml&quot;</span><span class="p">,</span> <span class="n">lfns</span><span class="p">,</span> <span class="n">writetofile</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">writetofile</span><span class="p">)</span>

    <span class="c1"># Explicitly add the ATHENA_PROC_NUMBER (or JOB value)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">add_athena_proc_number</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">show_memory_usage</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;payload run command: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="get_normal_payload_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_normal_payload_command">[docs]</a><span class="k">def</span> <span class="nf">get_normal_payload_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">preparesetup</span><span class="p">,</span> <span class="n">userjob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the payload command for a normal production/analysis job.</span>

<span class="sd">    :param cmd: any preliminary command setup (string).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param userjob: True for user analysis jobs, False otherwise (bool).</span>
<span class="sd">    :param preparesetup: True if the pilot should prepare the setup, False if already in the job parameters.</span>
<span class="sd">    :return: normal payload command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set the INDS env variable (used by runAthena but also for EventIndex production jobs)</span>
    <span class="n">set_inds</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">datasetin</span><span class="p">)</span>  <span class="c1"># realDatasetsIn</span>

    <span class="k">if</span> <span class="n">userjob</span><span class="p">:</span>
        <span class="c1"># Try to download the trf (skip when user container is to be used)</span>
        <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">trf_name</span> <span class="o">=</span> <span class="n">get_analysis_trf</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TrfDownloadFailure</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;user analysis trf: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trf_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">preparesetup</span><span class="p">:</span>
            <span class="n">_cmd</span> <span class="o">=</span> <span class="n">get_analysis_run_command</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">trf_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_cmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span>

        <span class="c1"># Correct for multi-core if necessary (especially important in case coreCount=1 to limit parallel make)</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="n">add_makeflags</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">corecount</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_cmd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add Database commands if they are set by the local site</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_DB_LOCAL_SETUP_CMD&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_eventservice</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;; export ATHENA_PROC_NUMBER=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;; export ATHENA_CORE_NUMBER=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;; export ATHENA_PROC_NUMBER=1&#39;</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;; export ATHENA_CORE_NUMBER=1&#39;</span>

        <span class="c1"># Add the transform and the job parameters (production jobs)</span>
        <span class="k">if</span> <span class="n">preparesetup</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;; </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="get_generic_payload_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_generic_payload_command">[docs]</a><span class="k">def</span> <span class="nf">get_generic_payload_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">preparesetup</span><span class="p">,</span> <span class="n">userjob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param cmd:</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param preparesetup:</span>
<span class="sd">    :param userjob: True for user analysis jobs, False otherwise (bool).</span>
<span class="sd">    :return: generic job command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">userjob</span><span class="p">:</span>
        <span class="c1"># Try to download the trf</span>
        <span class="c1">#if job.imagename != &quot;&quot; or &quot;--containerImage&quot; in job.jobparams:</span>
        <span class="c1">#    job.transformation = os.path.join(os.path.dirname(job.transformation), &quot;runcontainer&quot;)</span>
        <span class="c1">#    logger.warning(&#39;overwrote job.transformation, now set to: %s&#39; % job.transformation)</span>
        <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">trf_name</span> <span class="o">=</span> <span class="n">get_analysis_trf</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TrfDownloadFailure</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;user analysis trf: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trf_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">preparesetup</span><span class="p">:</span>
            <span class="n">_cmd</span> <span class="o">=</span> <span class="n">get_analysis_run_command</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">trf_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_cmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span>

        <span class="c1"># correct for multi-core if necessary (especially important in case coreCount=1 to limit parallel make)</span>
        <span class="c1"># only if not using a user container</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="n">add_makeflags</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">corecount</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_cmd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">_cmd</span>

    <span class="k">elif</span> <span class="n">verify_release_string</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">homepackage</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;NULL&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">homepackage</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">preparesetup</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;python </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">homepackage</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">preparesetup</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;python </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="add_athena_proc_number"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.add_athena_proc_number">[docs]</a><span class="k">def</span> <span class="nf">add_athena_proc_number</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the ATHENA_PROC_NUMBER and ATHENA_CORE_NUMBER to the payload command if necessary.</span>

<span class="sd">    :param cmd: payload execution command (string).</span>
<span class="sd">    :return: updated payload execution command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get the values if they exist</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_PROC_NUMBER_JOB&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to convert ATHENA_PROC_NUMBER_JOB to int: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">value1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_CORE_NUMBER&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to convert ATHENA_CORE_NUMBER to int: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;ATHENA_PROC_NUMBER&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;ATHENA_PROC_NUMBER&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;export ATHENA_PROC_NUMBER=</span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_PROC_NUMBER&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd</span>
        <span class="k">elif</span> <span class="s2">&quot;ATHENA_PROC_NUMBER_JOB&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="n">value1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;export ATHENA_PROC_NUMBER=</span><span class="si">%d</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">value1</span> <span class="o">+</span> <span class="n">cmd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;will not add ATHENA_PROC_NUMBER to cmd since the value is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;don&#39;t know how to set ATHENA_PROC_NUMBER (could not find it in os.environ)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ATHENA_PROC_NUMBER already in job command&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;ATHENA_CORE_NUMBER&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="n">value2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value2</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;export ATHENA_CORE_NUMBER=</span><span class="si">%d</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">value2</span> <span class="o">+</span> <span class="n">cmd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;will not add ATHENA_CORE_NUMBER to cmd since the value is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;there is no ATHENA_CORE_NUMBER in os.environ (cannot add it to payload command)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="verify_release_string"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.verify_release_string">[docs]</a><span class="k">def</span> <span class="nf">verify_release_string</span><span class="p">(</span><span class="n">release</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that the release (or homepackage) string is set.</span>

<span class="sd">    :param release: release or homepackage string that might or might not be set.</span>
<span class="sd">    :return: release (set string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">release</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">release</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">release</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>
    <span class="k">if</span> <span class="n">release</span> <span class="o">==</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;detected unset (NULL) release/homepackage string&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">release</span></div>


<div class="viewcode-block" id="add_makeflags"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.add_makeflags">[docs]</a><span class="k">def</span> <span class="nf">add_makeflags</span><span class="p">(</span><span class="n">job_core_count</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct for multi-core if necessary (especially important in case coreCount=1 to limit parallel make).</span>

<span class="sd">    :param job_core_count: core count from the job definition (int).</span>
<span class="sd">    :param cmd: payload execution command (string).</span>
<span class="sd">    :return: updated payload execution command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ATHENA_PROC_NUMBER is set in Node.py using the schedconfig value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">core_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ATHENA_PROC_NUMBER&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">core_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">core_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">core_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_core_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">core_count</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Note: the original request (AF) was to use j%d and not -j%d, now using the latter</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;export MAKEFLAGS=</span><span class="se">\&#39;</span><span class="s2">-j</span><span class="si">%d</span><span class="s2"> QUICK=1 -l1</span><span class="se">\&#39;</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">core_count</span><span class="p">)</span>

    <span class="c1"># make sure that MAKEFLAGS is always set</span>
    <span class="k">if</span> <span class="s2">&quot;MAKEFLAGS=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;export MAKEFLAGS=</span><span class="se">\&#39;</span><span class="s2">-j1 QUICK=1 -l1</span><span class="se">\&#39;</span><span class="s2">;&quot;</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="get_analysis_run_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_analysis_run_command">[docs]</a><span class="k">def</span> <span class="nf">get_analysis_run_command</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">trf_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the proper run command for the user job.</span>

<span class="sd">    Example output: export X509_USER_PROXY=&lt;..&gt;;./runAthena &lt;job parameters&gt; --usePFCTurl --directIn</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param trf_name: name of the transform that will run the job (string). Used when containers are not used.</span>
<span class="sd">    :return: command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># get relevant file transfer info</span>
    <span class="c1">#use_copy_tool, use_direct_access, use_pfc_turl = get_file_transfer_info(job)</span>
    <span class="c1"># check if the input files are to be accessed locally (ie if prodDBlockToken is set to local)</span>
    <span class="c1">#if job.is_local():   ## useless since stage-in phase has already passed (DEPRECATE ME, anisyonk)</span>
    <span class="c1">#    logger.debug(&#39;switched off direct access for local prodDBlockToken&#39;)</span>
    <span class="c1">#    use_direct_access = False</span>
    <span class="c1">#    use_pfc_turl = False</span>

    <span class="c1"># add the user proxy</span>
    <span class="k">if</span> <span class="s1">&#39;X509_USER_PROXY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;export X509_USER_PROXY=</span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X509_USER_PROXY&#39;</span><span class="p">)</span>

    <span class="c1"># set up trfs</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># user jobs with no imagename defined</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;./</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trf_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;./</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trf_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;python </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trf_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">)</span>

        <span class="n">imagename</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">imagename</span>
        <span class="c1"># check if image is on disk as defined by envar PAYLOAD_CONTAINER_LOCATION</span>
        <span class="n">payload_container_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PAYLOAD_CONTAINER_LOCATION&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payload_container_location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;$PAYLOAD_CONTAINER_LOCATION = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">payload_container_location</span><span class="p">)</span>
            <span class="c1"># get container name</span>
            <span class="n">containername</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">image_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">payload_container_location</span><span class="p">,</span> <span class="n">containername</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_location</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;image exists at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">image_location</span><span class="p">)</span>
                <span class="n">imagename</span> <span class="o">=</span> <span class="n">image_location</span>

        <span class="c1"># restore the image name if necessary</span>
        <span class="k">if</span> <span class="s1">&#39;containerImage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s1">&#39;runcontainer&#39;</span> <span class="ow">in</span> <span class="n">trf_name</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; --containerImage=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">imagename</span>

    <span class="c1"># add control options for PFC turl and direct access</span>
    <span class="c1">#if job.indata:   ## DEPRECATE ME (anisyonk)</span>
    <span class="c1">#    if use_pfc_turl and &#39;--usePFCTurl&#39; not in cmd:</span>
    <span class="c1">#        cmd += &#39; --usePFCTurl&#39;</span>
    <span class="c1">#    if use_direct_access and &#39;--directIn&#39; not in cmd:</span>
    <span class="c1">#        cmd += &#39; --directIn&#39;</span>

    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">has_remoteio</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;direct access (remoteio) is used to access some input files: --usePFCTurl and --directIn will be added to payload command&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;--usePFCTurl&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; --usePFCTurl&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;--directIn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; --directIn&#39;</span>

    <span class="c1"># update the payload command for forced accessmode</span>
    <span class="c1">## -- REDUNDANT logic, since it should be done from the beginning at the step of FileSpec initialization (anisyonk)</span>
    <span class="c1">#cmd = update_forced_accessmode(log, cmd, job.transfertype, job.jobparams, trf_name)  ## DEPRECATE ME (anisyonk)</span>

    <span class="c1"># add guids when needed</span>
    <span class="c1"># get the correct guids list (with only the direct access files)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_build_job</span><span class="p">():</span>
        <span class="n">lfns</span><span class="p">,</span> <span class="n">guids</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_lfns_and_guids</span><span class="p">()</span>
        <span class="n">_guids</span> <span class="o">=</span> <span class="n">get_guids_from_jobparams</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobparams</span><span class="p">,</span> <span class="n">lfns</span><span class="p">,</span> <span class="n">guids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_guids</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; --inputGUIDs </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_guids</span><span class="p">))</span>

    <span class="n">show_memory_usage</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<span class="c1">## SHOULD NOT BE USED since payload cmd should be properly generated from the beginning (consider final directio settings) (anisyonk)</span>
<div class="viewcode-block" id="update_forced_accessmode"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.update_forced_accessmode">[docs]</a><span class="k">def</span> <span class="nf">update_forced_accessmode</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">transfertype</span><span class="p">,</span> <span class="n">jobparams</span><span class="p">,</span> <span class="n">trf_name</span><span class="p">):</span>  <span class="c1">## DEPRECATE ME (anisyonk)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the payload command for forced accessmode.</span>
<span class="sd">    accessmode is an option that comes from HammerCloud and is used to force a certain input file access mode; i.e.</span>
<span class="sd">    copy-to-scratch or direct access.</span>

<span class="sd">    :param log: logging object.</span>
<span class="sd">    :param cmd: payload command.</span>
<span class="sd">    :param transfertype: transfer type (.e.g &#39;direct&#39;) from the job definition with priority over accessmode (string).</span>
<span class="sd">    :param jobparams: job parameters (string).</span>
<span class="sd">    :param trf_name: transformation name (string).</span>
<span class="sd">    :return: updated payload command string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;accessmode&quot;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="n">transfertype</span> <span class="o">!=</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
        <span class="n">accessmode_usect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">accessmode_directin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_accessmode_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;--accessmode=copy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;copy-to-scratch mode&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                           <span class="s2">&quot;--accessmode=direct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;direct access mode&quot;</span><span class="p">,</span> <span class="s2">&quot; --directIn&quot;</span><span class="p">]}</span>

        <span class="c1"># update run_command according to jobPars</span>
        <span class="k">for</span> <span class="n">_mode</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_accessmode_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># Python 2/3</span>
            <span class="k">if</span> <span class="n">_mode</span> <span class="ow">in</span> <span class="n">jobparams</span><span class="p">:</span>
                <span class="c1"># any accessmode set in jobPars should overrule schedconfig</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enforcing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_accessmode_dic</span><span class="p">[</span><span class="n">_mode</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;--accessmode=copy&quot;</span><span class="p">:</span>
                    <span class="c1"># make sure direct access is turned off</span>
                    <span class="n">accessmode_usect</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">accessmode_directin</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;--accessmode=direct&quot;</span><span class="p">:</span>
                    <span class="c1"># make sure copy-to-scratch gets turned off</span>
                    <span class="n">accessmode_usect</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">accessmode_directin</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">accessmode_usect</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">accessmode_directin</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># update run_command (do not send the accessmode switch to runAthena)</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="n">_accessmode_dic</span><span class="p">[</span><span class="n">_mode</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">_mode</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">_mode</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># force usage of copy tool for stage-in or direct access</span>
        <span class="k">if</span> <span class="n">accessmode_usect</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;forced copy tool usage selected&#39;</span><span class="p">)</span>
            <span class="c1"># remove again the &quot;--directIn&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;directIn&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; --directIn&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">accessmode_directin</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;forced direct access usage selected&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;directIn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; --directIn&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;neither forced copy tool usage nor direct access was selected&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;directIn&quot;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s2">&quot;usePFCTurl&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; --usePFCTurl&#39;</span>

        <span class="c1"># need to add proxy if not there already</span>
        <span class="k">if</span> <span class="s2">&quot;--directIn&quot;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s2">&quot;export X509_USER_PROXY&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;X509_USER_PROXY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;./</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">trf_name</span><span class="p">,</span> <span class="s2">&quot;export X509_USER_PROXY=</span><span class="si">%s</span><span class="s2">;./</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X509_USER_PROXY&#39;</span><span class="p">),</span> <span class="n">trf_name</span><span class="p">))</span>

    <span class="c1"># if both direct access and the accessmode loop added a directIn switch, remove the first one from the string</span>
    <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;directIn&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; --directIn&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="get_guids_from_jobparams"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_guids_from_jobparams">[docs]</a><span class="k">def</span> <span class="nf">get_guids_from_jobparams</span><span class="p">(</span><span class="n">jobparams</span><span class="p">,</span> <span class="n">infiles</span><span class="p">,</span> <span class="n">infilesguids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the correct guid from the input file list.</span>
<span class="sd">    The guids list is used for direct reading.</span>
<span class="sd">    1. extract input file list for direct reading from job parameters</span>
<span class="sd">    2. for each input file in this list, find the corresponding guid from the input file guid list</span>
<span class="sd">    Since the job parameters string is entered by a human, the order of the input files might not be the same.</span>

<span class="sd">    :param jobparams: job parameters.</span>
<span class="sd">    :param infiles: input file list.</span>
<span class="sd">    :param infilesguids: input file guids list.</span>
<span class="sd">    :return: guids list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">guidlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jobparams</span> <span class="o">=</span> <span class="n">jobparams</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">jobparams</span> <span class="o">=</span> <span class="n">jobparams</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\-i \&quot;\[([A-Za-z0-9.,_-]+)\]\&quot;&#39;</span><span class="p">)</span>
    <span class="n">directreadinginputfiles</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">jobparams</span><span class="p">)</span>
    <span class="n">_infiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">directreadinginputfiles</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">_infiles</span> <span class="o">=</span> <span class="n">directreadinginputfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-i ([A-Za-z0-9.\[\],_-]+) &quot;</span><span class="p">,</span> <span class="n">jobparams</span><span class="p">)</span>  <span class="c1"># Python 3 (added r)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compactinfiles</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.*)\[(.+)\](.*)\[(.+)\]&#39;</span><span class="p">,</span> <span class="n">compactinfiles</span><span class="p">)</span>  <span class="c1"># Python 3 (added r)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">infiles</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tail</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)):</span>
                    <span class="n">lfn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">tail</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">infiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lfn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">infiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">compactinfiles</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">_infiles</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">_infiles</span><span class="p">:</span>
            <span class="c1"># get the corresponding index from the inputFiles list, which has the same order as infilesguids</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">infiles</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;exception caught: </span><span class="si">%s</span><span class="s2"> (direct reading will fail)&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># add the corresponding guid to the list</span>
                <span class="n">guidlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">infilesguids</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">guidlist</span></div>


<div class="viewcode-block" id="get_file_transfer_info"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_file_transfer_info">[docs]</a><span class="k">def</span> <span class="nf">get_file_transfer_info</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>   <span class="c1">## TO BE DEPRECATED, NOT USED (anisyonk)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return information about desired file transfer.</span>

<span class="sd">    :param job: job object</span>
<span class="sd">    :return: use copy tool (boolean), use direct access (boolean), use PFC Turl (boolean).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_copy_tool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_direct_access</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_pfc_turl</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># check with schedconfig</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">direct_access_lan</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">direct_access_wan</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">transfertype</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_build_job</span><span class="p">():</span>
        <span class="c1"># override if all input files are copy-to-scratch</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">only_copy_to_scratch</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;all input files are copy-to-scratch (--usePFCTurl and --directIn will not be set)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;--usePFCTurl and --directIn will be set&#39;</span><span class="p">)</span>
            <span class="n">use_copy_tool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">use_direct_access</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">use_pfc_turl</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">use_copy_tool</span><span class="p">,</span> <span class="n">use_direct_access</span><span class="p">,</span> <span class="n">use_pfc_turl</span></div>


<div class="viewcode-block" id="update_job_data"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.update_job_data">[docs]</a><span class="k">def</span> <span class="nf">update_job_data</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function can be used to update/add data to the job object.</span>
<span class="sd">    E.g. user specific information can be extracted from other job object fields. In the case of ATLAS, information</span>
<span class="sd">    is extracted from the metadata field and added to other job object fields.</span>

<span class="sd">    :param job: job object</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## comment from Alexey:</span>
    <span class="c1">## it would be better to reallocate this logic (as well as parse metadata values)directly to Job object</span>
    <span class="c1">## since in general it&#39;s Job related part</span>
    <span class="c1">## later on once we introduce VO specific Job class (inherited from JobData) this can be easily customized</span>

    <span class="c1"># get label &quot;all&quot; or &quot;log&quot;</span>
    <span class="n">stageout</span> <span class="o">=</span> <span class="n">get_stageout_label</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;exeErrorDiag&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">exeerrordiag</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;exeErrorDiag&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrordiag</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;payload failed: exeErrorDiag=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrordiag</span><span class="p">)</span>

    <span class="c1"># determine what should be staged out</span>
    <span class="n">job</span><span class="o">.</span><span class="n">stageout</span> <span class="o">=</span> <span class="n">stageout</span>  <span class="c1"># output and log file or only log file</span>

    <span class="n">work_attributes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">work_attributes</span> <span class="o">=</span> <span class="n">parse_jobreport_data</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to parse job report (cannot set job.nevents): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># note: the number of events can be set already at this point if the value was extracted from the job report</span>
        <span class="c1"># (a more thorough search for this value is done later unless it was set here)</span>
        <span class="n">nevents</span> <span class="o">=</span> <span class="n">work_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nEvents&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nevents</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="n">nevents</span>

    <span class="c1"># extract output files from the job report if required, in case the trf has created additional (overflow) files</span>
    <span class="c1"># also make sure all guids are assigned (use job report value if present, otherwise generate the guid)</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_eventservice</span><span class="p">:</span>
        <span class="n">extract_output_file_guids</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1"># keep this for now, complicated to merge with verify_output_files?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">verify_output_files</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught while trying verify output files: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>  <span class="c1"># i.e. if it&#39;s an empty list/string, do nothing</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;will not try to extract output files from jobReport for user job (and allowNoOut list is empty)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># remove the files listed in allowNoOutput if they don&#39;t exist</span>
            <span class="n">remove_no_output_files</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="c1">## validate output data (to be moved into the JobData)</span>
    <span class="c1">## warning: do no execute this code unless guid lookup in job report has failed - pilot should only generate guids</span>
    <span class="c1">## if they are not present in job report</span>
    <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dat</span><span class="o">.</span><span class="n">guid</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">.</span><span class="n">guid</span> <span class="o">=</span> <span class="n">get_guid</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;guid not set: generated guid=</span><span class="si">%s</span><span class="s1"> for lfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">lfn</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_stageout_label"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_stageout_label">[docs]</a><span class="k">def</span> <span class="nf">get_stageout_label</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a proper stage-out label.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: &quot;all&quot;/&quot;log&quot; depending on stage-out type (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stageout</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_eventservice</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;event service payload, will only stage-out log&#39;</span><span class="p">)</span>
        <span class="n">stageout</span> <span class="o">=</span> <span class="s2">&quot;log&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># handle any error codes</span>
        <span class="k">if</span> <span class="s1">&#39;exeErrorCode&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">exeerrorcode</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;exeErrorCode&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrorcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stageout</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;payload failed: exeErrorCode=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrorcode</span><span class="p">)</span>
                <span class="n">stageout</span> <span class="o">=</span> <span class="s2">&quot;log&quot;</span>

    <span class="k">return</span> <span class="n">stageout</span></div>


<div class="viewcode-block" id="update_output_for_hpo"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.update_output_for_hpo">[docs]</a><span class="k">def</span> <span class="nf">update_output_for_hpo</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the output (outdata) for HPO jobs.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_outdata</span> <span class="o">=</span> <span class="n">discover_new_outdata</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught while discovering new outdata: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_outdata</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;replacing job outdata with discovered output (</span><span class="si">%d</span><span class="s1"> file(s))&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_outdata</span><span class="p">))</span>
            <span class="n">job</span><span class="o">.</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">new_outdata</span></div>


<div class="viewcode-block" id="discover_new_outdata"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.discover_new_outdata">[docs]</a><span class="k">def</span> <span class="nf">discover_new_outdata</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover new outdata created by HPO job.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: new_outdata (list of FileSpec objects)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pilot.info.filespec</span> <span class="kn">import</span> <span class="n">FileSpec</span>
    <span class="n">new_outdata</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">outdata_file</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
        <span class="n">new_output</span> <span class="o">=</span> <span class="n">discover_new_output</span><span class="p">(</span><span class="n">outdata_file</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_output</span><span class="p">:</span>
            <span class="c1"># create new FileSpec objects out of the new output</span>
            <span class="k">for</span> <span class="n">outfile</span> <span class="ow">in</span> <span class="n">new_output</span><span class="p">:</span>
                <span class="c1"># note: guid will be taken from job report after this function has been called</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">outdata_file</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;lfn&#39;</span><span class="p">:</span> <span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;workdir&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
                          <span class="s1">&#39;dataset&#39;</span><span class="p">:</span> <span class="n">outdata_file</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;ddmendpoint&#39;</span><span class="p">:</span> <span class="n">outdata_file</span><span class="o">.</span><span class="n">ddmendpoint</span><span class="p">,</span>
                          <span class="s1">&#39;ddmendpoint_alt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;filesize&#39;</span><span class="p">:</span> <span class="n">new_output</span><span class="p">[</span><span class="n">outfile</span><span class="p">][</span><span class="s1">&#39;filesize&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="n">new_output</span><span class="p">[</span><span class="n">outfile</span><span class="p">][</span><span class="s1">&#39;checksum&#39;</span><span class="p">],</span> <span class="s1">&#39;guid&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}]</span>
                <span class="c1"># do not abbreviate the following two lines as otherwise the content of xfiles will be a list of generator objects</span>
                <span class="n">_xfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">FileSpec</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
                <span class="n">new_outdata</span> <span class="o">+=</span> <span class="n">_xfiles</span>

    <span class="k">return</span> <span class="n">new_outdata</span></div>


<div class="viewcode-block" id="discover_new_output"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.discover_new_output">[docs]</a><span class="k">def</span> <span class="nf">discover_new_output</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover new output created by HPO job in the given work dir.</span>

<span class="sd">    name_pattern for known &#39;filename&#39; is &#39;filename_N&#39; (N = 0, 1, 2, ..).</span>
<span class="sd">    Example: name_pattern = 23578835.metrics.000001.tgz</span>
<span class="sd">             should discover files with names 23578835.metrics.000001.tgz_N (N = 0, 1, ..)</span>

<span class="sd">    new_output = { lfn: {&#39;path&#39;: path, &#39;size&#39;: size, &#39;checksum&#39;: checksum}, .. }</span>

<span class="sd">    :param name_pattern: assumed name pattern for file to discover (string).</span>
<span class="sd">    :param workdir: work directory (string).</span>
<span class="sd">    :return: new_output (dictionary).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_*&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">lfns</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">lfn</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lfns</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)):</span>
            <span class="c1"># get file size</span>
            <span class="n">filesize</span> <span class="o">=</span> <span class="n">get_local_file_size</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1"># get checksum</span>
            <span class="n">checksum</span> <span class="o">=</span> <span class="n">calculate_checksum</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">filesize</span> <span class="ow">and</span> <span class="n">checksum</span><span class="p">:</span>
                <span class="n">new_output</span><span class="p">[</span><span class="n">lfn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;filesize&#39;</span><span class="p">:</span> <span class="n">filesize</span><span class="p">,</span> <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="n">checksum</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to create file info (filesize=</span><span class="si">%d</span><span class="s1">, checksum=</span><span class="si">%s</span><span class="s1">) for lfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">filesize</span><span class="p">,</span> <span class="n">checksum</span><span class="p">,</span> <span class="n">lfn</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_output</span></div>


<div class="viewcode-block" id="extract_output_file_guids"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.extract_output_file_guids">[docs]</a><span class="k">def</span> <span class="nf">extract_output_file_guids</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract output file info from the job report and make sure all guids are assigned (use job report value if present,</span>
<span class="sd">    otherwise generate the guid - note: guid generation is done later, not in this function since this function</span>
<span class="sd">    might not be called if metadata info is not found prior to the call).</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make sure there is a defined output file list in the job report - unless it is allowed by task parameter allowNoOutput</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;verified that job report contains metadata for </span><span class="si">%d</span><span class="s1"> file(s)&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;job report contains no output files and allowNoOutput is not set&#39;</span><span class="p">)</span>  <span class="c1">#- will fail job since allowNoOutput is not set&#39;)</span>
            <span class="c1">#job.piloterrorcodes, job.piloterrordiags = errors.add_error_code(errors.NOOUTPUTINJOBREPORT)</span>
            <span class="k">return</span>

    <span class="c1"># extract info from metadata (job report JSON)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">lfn</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">)</span>
    <span class="c1">#extra = []</span>
    <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">fdat</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subFiles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">lfn</span> <span class="o">=</span> <span class="n">fdat</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

            <span class="c1"># verify the guid if the lfn is known</span>
            <span class="c1"># only extra guid if the file is known by the job definition (March 18 change, v 2.5.2)</span>
            <span class="k">if</span> <span class="n">lfn</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">lfn</span><span class="p">]</span><span class="o">.</span><span class="n">guid</span> <span class="o">=</span> <span class="n">fdat</span><span class="p">[</span><span class="s1">&#39;file_guid&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set guid=</span><span class="si">%s</span><span class="s1"> for lfn=</span><span class="si">%s</span><span class="s1"> (value taken from job report)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">lfn</span><span class="p">]</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">lfn</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># found new entry</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;pilot no longer considers output files not mentioned in job definition (lfn=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="k">continue</span>

                <span class="c1">#if job.outdata:</span>
                <span class="c1">#    kw = {&#39;lfn&#39;: lfn,</span>
                <span class="c1">#          &#39;scope&#39;: job.outdata[0].scope,  ## take value from 1st output file?</span>
                <span class="c1">#          &#39;guid&#39;: fdat[&#39;file_guid&#39;],</span>
                <span class="c1">#          &#39;filesize&#39;: fdat[&#39;file_size&#39;],</span>
                <span class="c1">#          &#39;dataset&#39;: dat.get(&#39;dataset&#39;) or job.outdata[0].dataset  ## take value from 1st output file?</span>
                <span class="c1">#          }</span>
                <span class="c1">#    spec = FileSpec(filetype=&#39;output&#39;, **kw)</span>
                <span class="c1">#    extra.append(spec)</span>

    <span class="c1"># make sure the output list has set guids from job report</span>
    <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">guid</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">]</span><span class="o">.</span><span class="n">guid</span><span class="p">:</span>
            <span class="n">fspec</span><span class="o">.</span><span class="n">guid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">]</span><span class="o">.</span><span class="n">guid</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;reset guid=</span><span class="si">%s</span><span class="s1"> for lfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">guid</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;verified guid=</span><span class="si">%s</span><span class="s1"> for lfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;guid not set for lfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span></div>
    <span class="c1">#if extra:</span>
        <span class="c1">#logger.info(&#39;found extra output files in job report, will overwrite output file list: extra=%s&#39; % extra)</span>
        <span class="c1">#job.outdata = extra</span>


<div class="viewcode-block" id="verify_output_files"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.verify_output_files">[docs]</a><span class="k">def</span> <span class="nf">verify_output_files</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure that the known output files from the job definition are listed in the job report and number of processed events</span>
<span class="sd">    is greater than zero. If the output file is not listed in the job report, then if the file is listed in allowNoOutput</span>
<span class="sd">    remove it from stage-out, otherwise fail the job.</span>

<span class="sd">    Note from Rod: fail scenario: The output file is not in output:[] or is there with zero events. Then if allownooutput is not</span>
<span class="sd">    set - fail the job. If it is set, then do not store the output, and finish ok.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: Boolean (and potentially updated job.outdata list)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># get list of output files from the job definition</span>
    <span class="n">lfns_jobdef</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
        <span class="n">lfns_jobdef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lfns_jobdef</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;empty output file list from job definition (nothing to verify)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># get list of output files from job report</span>
    <span class="c1"># (if None is returned, it means the job report is from an old release and does not contain an output list)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ie empty list, output=[] - are all known output files in allowNoOutput?</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;encountered an empty output file list in job report, consulting allowNoOutput list&#39;</span><span class="p">)</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">lfn</span> <span class="ow">in</span> <span class="n">lfns_jobdef</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lfn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;lfn </span><span class="si">%s</span><span class="s1"> is not in allowNoOutput list - ignore for user job&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;lfn </span><span class="si">%s</span><span class="s1"> is not in allowNoOutput list - job will fail&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">MISSINGOUTPUTFILE</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;lfn </span><span class="si">%s</span><span class="s1"> listed in allowNoOutput - will be removed from stage-out&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="n">remove_from_stageout</span><span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ie job report is ancient / output could not be extracted</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;output file list could not be extracted from job report (nothing to verify)&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verified</span><span class="p">,</span> <span class="n">nevents</span> <span class="o">=</span> <span class="n">verify_extracted_output_files</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">lfns_jobdef</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verified</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">nevents</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">failed</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">nevents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="n">nevents</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;number of events from summed up output files: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nevents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;number of events previously set to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">nevents</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">failed</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;output file verification succeeded&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;output file verification failed&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="verify_extracted_output_files"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.verify_extracted_output_files">[docs]</a><span class="k">def</span> <span class="nf">verify_extracted_output_files</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">lfns_jobdef</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure all output files extracted from the job report are listed.</span>
<span class="sd">    Grab the number of events if possible.</span>

<span class="sd">    :param output: list of FileSpecs (list).</span>
<span class="sd">    :param lfns_jobdef: list of lfns strings from job definition (list).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: True if successful|False if failed, number of events (Boolean, int)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nevents</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_jobrep</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {lfn: nentries, ..}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;extracted output file list from job report - make sure all known output files are listed&#39;</span><span class="p">)</span>

    <span class="c1"># first collect the output files from the job report</span>
    <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fdat</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subFiles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="c1"># get the lfn</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># get the number of processed events and add the output file info to the dictionary</span>
            <span class="n">output_jobrep</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nentries&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># now make sure that the known output files are in the job report dictionary</span>
    <span class="k">for</span> <span class="n">lfn</span> <span class="ow">in</span> <span class="n">lfns_jobdef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lfn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_jobrep</span> <span class="ow">and</span> <span class="n">lfn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> from job definition is not present in job report and is not listed in allowNoOutput&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> from job definition is not present in job report and is not listed in allowNoOutput - job will fail&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">MISSINGOUTPUTFILE</span><span class="p">)</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">lfn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_jobrep</span> <span class="ow">and</span> <span class="n">lfn</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> from job definition is not present in job report but is listed in allowNoOutput - remove from stage-out&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
            <span class="n">remove_from_stageout</span><span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nentries</span> <span class="o">=</span> <span class="n">output_jobrep</span><span class="p">[</span><span class="n">lfn</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nentries</span> <span class="o">==</span> <span class="s2">&quot;UNDEFINED&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;encountered file with nentries=UNDEFINED - will ignore </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">nentries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lfn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> is listed in job report, but has no events and is not listed in allowNoOutput - will ignore&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">nentries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lfn</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> is listed in job report, nentries is None and is listed in allowNoOutput - remove from stage-out&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="n">remove_from_stageout</span><span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">nentries</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">nentries</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lfn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> is listed in job report, has zero events and is not listed in allowNoOutput - will ignore&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">nentries</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">nentries</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lfn</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> is listed in job report, has zero events and is listed in allowNoOutput - remove from stage-out&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
                <span class="n">remove_from_stageout</span><span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">nentries</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">nentries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;output file </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%d</span><span class="s1"> event(s)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="n">nentries</span><span class="p">))</span>
                <span class="n">nevents</span> <span class="o">+=</span> <span class="n">nentries</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># should not reach this step</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;case not handled for output file </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> event(s) (ignore)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nentries</span><span class="p">)))</span>

    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">failed</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">nevents</span></div>


<div class="viewcode-block" id="remove_from_stageout"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.remove_from_stageout">[docs]</a><span class="k">def</span> <span class="nf">remove_from_stageout</span><span class="p">(</span><span class="n">lfn</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From the given lfn from the stage-out list.</span>

<span class="sd">    :param lfn: local file name (string).</span>
<span class="sd">    :param job: job object</span>
<span class="sd">    :return: [updated job object]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outdata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span> <span class="o">==</span> <span class="n">lfn</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="si">%s</span><span class="s1"> from stage-out list&#39;</span> <span class="o">%</span> <span class="n">lfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fspec</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">outdata</span></div>


<div class="viewcode-block" id="remove_no_output_files"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.remove_no_output_files">[docs]</a><span class="k">def</span> <span class="nf">remove_no_output_files</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove files from output file list if they are listed in allowNoOutput and do not exist.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># first identify the files to keep</span>
    <span class="n">_outfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">allownooutput</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> is listed in allowNoOutput but exists (will not be removed from list of files to be staged-out)&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">_outfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> is listed in allowNoOutput and does not exist (will be removed from list of files to be staged-out)&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> is not listed in allowNoOutput (will be staged-out)&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> is not listed in allowNoOutput and does not exist (job will fail)&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">_outfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># now remove the unwanted fspecs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_outfiles</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">):</span>
        <span class="n">outdata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span> <span class="ow">in</span> <span class="n">_outfiles</span><span class="p">:</span>
                <span class="n">outdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fspec</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">outdata</span></div>


<div class="viewcode-block" id="get_outfiles_records"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_outfiles_records">[docs]</a><span class="k">def</span> <span class="nf">get_outfiles_records</span><span class="p">(</span><span class="n">subfiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract file info from job report JSON subfiles entry.</span>

<span class="sd">    :param subfiles: list of subfiles.</span>
<span class="sd">    :return: file info dictionary with format { &#39;guid&#39;: .., &#39;size&#39;: .., &#39;nentries&#39;: .. (optional)}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">subfiles</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;guid&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_guid&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">]}</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nentries&#39;</span><span class="p">,</span> <span class="s1">&#39;UNDEFINED&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nentries</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;nentries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nentries</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;nentries is undefined in job report&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="DictQuery"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.DictQuery">[docs]</a><span class="k">class</span> <span class="nc">DictQuery</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<div class="viewcode-block" id="DictQuery.get"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.DictQuery.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dst_dict</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">last_key</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">last_key</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">dst_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="parse_jobreport_data"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.parse_jobreport_data">[docs]</a><span class="k">def</span> <span class="nf">parse_jobreport_data</span><span class="p">(</span><span class="n">job_report</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a job report and extract relevant fields.</span>

<span class="sd">    :param job_report:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">work_attributes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">job_report</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">job_report</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">work_attributes</span>

    <span class="c1"># these are default values for job metrics</span>
    <span class="n">core_count</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;nEvents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;dbTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;dbData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;inputfiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;outputfiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s2">&quot;ATHENA_PROC_NUMBER&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ATHENA_PROC_NUMBER: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ATHENA_PROC_NUMBER&quot;</span><span class="p">]))</span>
        <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;core_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ATHENA_PROC_NUMBER&quot;</span><span class="p">])</span>
        <span class="n">core_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ATHENA_PROC_NUMBER&quot;</span><span class="p">])</span>

    <span class="n">dq</span> <span class="o">=</span> <span class="n">DictQuery</span><span class="p">(</span><span class="n">job_report</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource/transform/processedEvents&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;nEvents&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource/transform/cpuTimeTotal&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;cpuConsumptionTime&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource/machine/node&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource/machine/model_name&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;cpuConsumptionUnit&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource/dbTimeTotal&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;dbTime&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource/dbDataTotal&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;dbData&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exitCode&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;transExitCode&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exitMsg&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;exeErrorDiag&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files/input&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;inputfiles&quot;</span><span class="p">)</span>
    <span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files/output&quot;</span><span class="p">,</span> <span class="n">work_attributes</span><span class="p">,</span> <span class="s2">&quot;outputfiles&quot;</span><span class="p">)</span>

    <span class="n">outputfiles_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">of</span> <span class="ow">in</span> <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;outputfiles&#39;</span><span class="p">]:</span>
        <span class="n">outputfiles_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_outfiles_records</span><span class="p">(</span><span class="n">of</span><span class="p">[</span><span class="s1">&#39;subFiles&#39;</span><span class="p">]))</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;outputfiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputfiles_dict</span>

    <span class="k">if</span> <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;inputfiles&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">is_python3</span><span class="p">():</span>
            <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;nInputFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inpfiles</span><span class="p">[</span><span class="s1">&#39;subFiles&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">inpfiles</span> <span class="ow">in</span>
                                                                         <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;inputfiles&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;nInputFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">inpfiles</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">inpfiles</span><span class="p">[</span><span class="s1">&#39;subFiles&#39;</span><span class="p">]),</span>
                                                                            <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;inputfiles&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="s1">&#39;resource&#39;</span> <span class="ow">in</span> <span class="n">job_report</span> <span class="ow">and</span> <span class="s1">&#39;executor&#39;</span> <span class="ow">in</span> <span class="n">job_report</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">job_report</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;executor&#39;</span><span class="p">]</span>
        <span class="n">exc_report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fin_report</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_tmplist</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="s1">&#39;memory&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Max&#39;</span> <span class="ow">or</span> <span class="s1">&#39;Avg&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]),</span> <span class="n">j</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>  <span class="c1"># Python 2</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_tmplist</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="k">if</span>
                        <span class="s1">&#39;memory&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Max&#39;</span> <span class="ow">or</span> <span class="s1">&#39;Avg&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">])]</span>  <span class="c1"># Python 3</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_tmplist</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Avg&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]:</span>
                <span class="n">exc_report</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">][</span><span class="s1">&#39;Avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>  <span class="c1"># Python 2/3</span>
            <span class="k">if</span> <span class="s1">&#39;Max&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]:</span>
                <span class="n">exc_report</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">][</span><span class="s1">&#39;Max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>  <span class="c1"># Python 2/3</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exc_report</span><span class="p">:</span>
            <span class="n">fin_report</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">work_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fin_report</span><span class="p">)</span>

    <span class="n">workdir_size</span> <span class="o">=</span> <span class="n">get_workdir_size</span><span class="p">()</span>
    <span class="n">work_attributes</span><span class="p">[</span><span class="s1">&#39;jobMetrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;coreCount=</span><span class="si">%s</span><span class="s1"> nEvents=</span><span class="si">%s</span><span class="s1"> dbTime=</span><span class="si">%s</span><span class="s1"> dbData=</span><span class="si">%s</span><span class="s1"> workDirSize=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">core_count</span><span class="p">,</span>
                                        <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;nEvents&quot;</span><span class="p">],</span>
                                        <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;dbTime&quot;</span><span class="p">],</span>
                                        <span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;dbData&quot;</span><span class="p">],</span>
                                        <span class="n">workdir_size</span><span class="p">)</span>
    <span class="k">del</span><span class="p">(</span><span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;dbData&quot;</span><span class="p">])</span>
    <span class="k">del</span><span class="p">(</span><span class="n">work_attributes</span><span class="p">[</span><span class="s2">&quot;dbTime&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">work_attributes</span></div>


<div class="viewcode-block" id="get_workdir_size"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_workdir_size">[docs]</a><span class="k">def</span> <span class="nf">get_workdir_size</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tmp function - move later to file_handling</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="s1">&#39;du -s&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_executor_dictionary"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_executor_dictionary">[docs]</a><span class="k">def</span> <span class="nf">get_executor_dictionary</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the &#39;executor&#39; dictionary from with a job report.</span>

<span class="sd">    :param jobreport_dictionary:</span>
<span class="sd">    :return: executor_dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">executor_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">jobreport_dictionary</span> <span class="o">!=</span> <span class="p">{}:</span>

        <span class="k">if</span> <span class="s1">&#39;resource&#39;</span> <span class="ow">in</span> <span class="n">jobreport_dictionary</span><span class="p">:</span>
            <span class="n">resource_dictionary</span> <span class="o">=</span> <span class="n">jobreport_dictionary</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;executor&#39;</span> <span class="ow">in</span> <span class="n">resource_dictionary</span><span class="p">:</span>
                <span class="n">executor_dictionary</span> <span class="o">=</span> <span class="n">resource_dictionary</span><span class="p">[</span><span class="s1">&#39;executor&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no such key: executor&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no such key: resource&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">executor_dictionary</span></div>


<div class="viewcode-block" id="get_number_of_events_deprecated"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_number_of_events_deprecated">[docs]</a><span class="k">def</span> <span class="nf">get_number_of_events_deprecated</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">):</span>  <span class="c1"># TODO: remove this function</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the number of events from the job report.</span>

<span class="sd">    :param jobreport_dictionary:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nevents</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># FORMAT: { format : total_events, .. }</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">executor_dictionary</span> <span class="o">=</span> <span class="n">get_executor_dictionary</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">executor_dictionary</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># &quot;RAWtoESD&quot;, .., Python 2/3</span>
            <span class="k">if</span> <span class="s1">&#39;nevents&#39;</span> <span class="ow">in</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">nevents</span><span class="p">:</span>
                    <span class="n">nevents</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span> <span class="o">+=</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">][</span><span class="s1">&#39;nevents&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nevents</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span> <span class="o">=</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">][</span><span class="s1">&#39;nevents&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;format </span><span class="si">%s</span><span class="s2"> has no such key: nevents&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">format</span><span class="p">))</span>

    <span class="c1"># Now find the largest number of events among the different formats</span>
    <span class="k">if</span> <span class="n">nevents</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nevents</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;exception caught: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">nmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;did not find the number of events in the job report&quot;</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">nmax</span></div>


<div class="viewcode-block" id="get_db_info"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_db_info">[docs]</a><span class="k">def</span> <span class="nf">get_db_info</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract and add up the DB info from the job report.</span>
<span class="sd">    This information is reported with the jobMetrics.</span>
<span class="sd">    Note: this function adds up the different dbData and dbTime&#39;s in the different executor steps. In modern job</span>
<span class="sd">    reports this might have been done already by the transform and stored in dbDataTotal and dbTimeTotal.</span>

<span class="sd">    :param jobreport_dictionary: job report dictionary.</span>
<span class="sd">    :return: db_time (int), db_data (long)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_data</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2  # noqa: F821</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">db_data</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Python 3</span>

    <span class="n">executor_dictionary</span> <span class="o">=</span> <span class="n">get_executor_dictionary</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">executor_dictionary</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># &quot;RAWtoESD&quot;, .., Python 2/3</span>
            <span class="k">if</span> <span class="s1">&#39;dbData&#39;</span> <span class="ow">in</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">db_data</span> <span class="o">+=</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">][</span><span class="s1">&#39;dbData&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;format </span><span class="si">%s</span><span class="s2"> has no such key: dbData&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">format</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;dbTime&#39;</span> <span class="ow">in</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">db_time</span> <span class="o">+=</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">][</span><span class="s1">&#39;dbTime&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;format </span><span class="si">%s</span><span class="s2"> has no such key: dbTime&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">format</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">db_time</span><span class="p">,</span> <span class="n">db_data</span></div>


<div class="viewcode-block" id="get_db_info_str"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_db_info_str">[docs]</a><span class="k">def</span> <span class="nf">get_db_info_str</span><span class="p">(</span><span class="n">db_time</span><span class="p">,</span> <span class="n">db_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert db_time, db_data to strings.</span>
<span class="sd">    E.g. dbData=&quot;105077960&quot;, dbTime=&quot;251.42&quot;.</span>

<span class="sd">    :param db_time: time (s)</span>
<span class="sd">    :param db_data: long integer</span>
<span class="sd">    :return: db_time_s, db_data_s (strings)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2  # noqa: F821</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Python 3</span>

    <span class="k">if</span> <span class="n">db_data</span> <span class="o">!=</span> <span class="n">zero</span><span class="p">:</span>
        <span class="n">db_data_s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">db_data_s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">db_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">db_time_s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_time</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">db_time_s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">db_time_s</span><span class="p">,</span> <span class="n">db_data_s</span></div>


<div class="viewcode-block" id="get_cpu_times"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_cpu_times">[docs]</a><span class="k">def</span> <span class="nf">get_cpu_times</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract and add up the total CPU times from the job report.</span>
<span class="sd">    E.g. (&#39;s&#39;, 5790L, 1.0).</span>

<span class="sd">    Note: this function is used with Event Service jobs</span>

<span class="sd">    :param jobreport_dictionary:</span>
<span class="sd">    :return: cpu_conversion_unit (unit), total_cpu_time, conversion_factor (output consistent with set_time_consumed())</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">total_cpu_time</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2 # noqa: F821</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">total_cpu_time</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Python 3</span>

    <span class="n">executor_dictionary</span> <span class="o">=</span> <span class="n">get_executor_dictionary</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">executor_dictionary</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># &quot;RAWtoESD&quot;, .., Python 2/3</span>
            <span class="k">if</span> <span class="s1">&#39;cpuTime&#39;</span> <span class="ow">in</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">total_cpu_time</span> <span class="o">+=</span> <span class="n">executor_dictionary</span><span class="p">[</span><span class="nb">format</span><span class="p">][</span><span class="s1">&#39;cpuTime&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;format </span><span class="si">%s</span><span class="s2"> has no such key: cpuTime&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">format</span><span class="p">))</span>

    <span class="n">conversion_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">cpu_conversion_unit</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>

    <span class="k">return</span> <span class="n">cpu_conversion_unit</span><span class="p">,</span> <span class="n">total_cpu_time</span><span class="p">,</span> <span class="n">conversion_factor</span></div>


<div class="viewcode-block" id="get_exit_info"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_exit_info">[docs]</a><span class="k">def</span> <span class="nf">get_exit_info</span><span class="p">(</span><span class="n">jobreport_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the exit code (exitCode) and exit message (exitMsg).</span>
<span class="sd">    E.g. (0, &#39;OK&#39;).</span>

<span class="sd">    :param jobreport_dictionary:</span>
<span class="sd">    :return: exit_code, exit_message</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">jobreport_dictionary</span><span class="p">[</span><span class="s1">&#39;exitCode&#39;</span><span class="p">],</span> <span class="n">jobreport_dictionary</span><span class="p">[</span><span class="s1">&#39;exitMsg&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="cleanup_looping_payload"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.cleanup_looping_payload">[docs]</a><span class="k">def</span> <span class="nf">cleanup_looping_payload</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a special cleanup for looping payloads.</span>
<span class="sd">    Remove any root and tmp files.</span>

<span class="sd">    :param workdir: working directory (string)</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;pool.root&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="cleanup_payload"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.cleanup_payload">[docs]</a><span class="k">def</span> <span class="nf">cleanup_payload</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">outputfiles</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleanup of payload (specifically AthenaMP) sub directories prior to log file creation.</span>
<span class="sd">    Also remove core dumps.</span>

<span class="sd">    :param workdir: working directory (string)</span>
<span class="sd">    :param outputfiles: list of output files</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">remove_core_dumps</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ampdir</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/athenaMP-workers-*&#39;</span> <span class="o">%</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">ampdir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;core&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;pool.root&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;tmp.&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">outfile</span> <span class="ow">in</span> <span class="n">outputfiles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_redundant_path"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_redundant_path">[docs]</a><span class="k">def</span> <span class="nf">get_redundant_path</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the path to the file containing the redundant files and directories to be removed prior to log file creation.</span>

<span class="sd">    :return: file path (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">redundant</span>

    <span class="c1"># correct /cvmfs if necessary</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/cvmfs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ATLAS_SW_BASE&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/cvmfs&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ATLAS_SW_BASE&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="get_redundants"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_redundants">[docs]</a><span class="k">def</span> <span class="nf">get_redundants</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get list of redundant files and directories (to be removed).</span>
<span class="sd">    The function will return the content of an external file. It that can&#39;t be read, then a list defined in this</span>
<span class="sd">    function will be returned instead. Any updates to the external file must be propagated to this function.</span>

<span class="sd">    :return: files and directories list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># try to read the list from the external file</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">get_redundant_path</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># do not use the cvmfs file since it is not being updated</span>
        <span class="n">dir_list</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dir_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dir_list</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;list of redundant files could not be read from external file: </span><span class="si">%s</span><span class="s1"> (will use internal list)&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># else return the following</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AtlasProduction*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;AtlasPoint1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;AtlasTier0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;buildJob*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CDRelease*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;csc*.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DBRelease*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;EvgenJobOptions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;external&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fort.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geant4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geomDB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geomDB_sqlite&quot;</span><span class="p">,</span>
                <span class="s2">&quot;home&quot;</span><span class="p">,</span>
                <span class="s2">&quot;o..pacman..o&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pacman-*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="s2">&quot;runAthena*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;share&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sources.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqlite*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tcf_*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;triggerDB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;trusted.caches&quot;</span><span class="p">,</span>
                <span class="s2">&quot;workdir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.data*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.events&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.py&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.pyc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.root*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;JEM&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tmp*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.tmp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.TMP&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MC11JobOptions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scratch&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*.writing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pwg*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pwhg*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*PROC*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;madevent&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*proxy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ckpt*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*runcontainer*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;*job.log.tgz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;runGen-*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;runAthena-*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pandawnutil/*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;src/*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;singularity_cachedir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_joproxy15&quot;</span><span class="p">,</span>
                <span class="s2">&quot;HAHM_*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Process&quot;</span><span class="p">,</span>
                <span class="s2">&quot;merged_lhef._0.events-new&quot;</span><span class="p">,</span>
                <span class="s2">&quot;singularity/*&quot;</span><span class="p">,</span>  <span class="c1"># new</span>
                <span class="s2">&quot;/cores&quot;</span><span class="p">,</span>  <span class="c1"># new</span>
                <span class="s2">&quot;/work&quot;</span><span class="p">,</span>  <span class="c1"># new</span>
                <span class="s2">&quot;docs/&quot;</span><span class="p">,</span>  <span class="c1"># new</span>
                <span class="s2">&quot;/pilot2&quot;</span><span class="p">]</span>  <span class="c1"># new</span>

    <span class="k">return</span> <span class="n">dir_list</span></div>


<div class="viewcode-block" id="remove_archives"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.remove_archives">[docs]</a><span class="k">def</span> <span class="nf">remove_archives</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explicitly remove any soft linked archives (.a files) since they will be dereferenced by the tar command</span>
<span class="sd">    (--dereference option).</span>

<span class="sd">    :param workdir: working directory (string)</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;*.a&#39;</span><span class="p">):</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">workdir</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;EventService_premerge_*.tar&#39;</span><span class="p">):</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">matches</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="cleanup_broken_links"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.cleanup_broken_links">[docs]</a><span class="k">def</span> <span class="nf">cleanup_broken_links</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a second pass to clean up any broken links prior to log file creation.</span>

<span class="sd">    :param workdir: working directory (string)</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">broken</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="c1"># Resolve relative symlinks</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
                    <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">target_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
                    <span class="n">broken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If it&#39;s not a symlink we&#39;re not interested.</span>
                <span class="k">continue</span>

    <span class="k">if</span> <span class="n">broken</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">broken</span><span class="p">:</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="ls"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.ls">[docs]</a><span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;ls -lF </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">workdir</span>
    <span class="n">ec</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stdout</span> <span class="o">+</span> <span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_special_files"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.remove_special_files">[docs]</a><span class="k">def</span> <span class="nf">remove_special_files</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">outputfiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove list of special files from the workdir.</span>

<span class="sd">    :param workdir: work directory (string).</span>
<span class="sd">    :param dir_list: list of special files (list).</span>
<span class="sd">    :param outputfiles: output files (list).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># note: these should be partial file/dir names, not containing any wildcards</span>
    <span class="n">exceptions_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;runargs&quot;</span><span class="p">,</span> <span class="s2">&quot;runwrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;jobReport&quot;</span><span class="p">,</span> <span class="s2">&quot;log.&quot;</span><span class="p">]</span>

    <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_dir</span> <span class="ow">in</span> <span class="n">dir_list</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">_dir</span><span class="p">))</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">to_delete</span> <span class="o">+=</span> <span class="n">_files</span>

    <span class="n">exclude_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">of</span> <span class="ow">in</span> <span class="n">outputfiles</span><span class="p">:</span>
        <span class="n">exclude_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">of</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_files</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remove_dir_tree</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_redundant_files"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.remove_redundant_files">[docs]</a><span class="k">def</span> <span class="nf">remove_redundant_files</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">outputfiles</span><span class="o">=</span><span class="p">[],</span> <span class="n">islooping</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove redundant files and directories prior to creating the log file.</span>

<span class="sd">    :param workdir: working directory (string).</span>
<span class="sd">    :param outputfiles: list of protected output files (list).</span>
<span class="sd">    :param islooping: looping job variable to make sure workDir is not removed in case of looping (boolean).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;removing redundant files prior to log creation&quot;</span><span class="p">)</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

    <span class="n">ls</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

    <span class="c1"># get list of redundant files and directories (to be removed)</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="n">get_redundants</span><span class="p">()</span>

    <span class="c1"># remove core and pool.root files from AthenaMP sub directories</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cleaning up payload&#39;</span><span class="p">)</span>
        <span class="n">cleanup_payload</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">outputfiles</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;failed to execute cleanup_payload(): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># explicitly remove any soft linked archives (.a files) since they will be dereferenced by the tar command</span>
    <span class="c1"># (--dereference option)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;removing archives&#39;</span><span class="p">)</span>
    <span class="n">remove_archives</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

    <span class="c1"># remove special files</span>
    <span class="n">remove_special_files</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">outputfiles</span><span class="p">)</span>

    <span class="c1"># run a second pass to clean up any broken links</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cleaning up broken links&#39;</span><span class="p">)</span>
    <span class="n">cleanup_broken_links</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

    <span class="c1"># remove any present user workDir</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;workDir&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># remove at least root files from workDir (ie also in the case of looping job)</span>
        <span class="n">cleanup_looping_payload</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">islooping</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="se">\&#39;</span><span class="s1">workDir</span><span class="se">\&#39;</span><span class="s1"> from workdir=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">workdir</span><span class="p">)</span>
            <span class="n">remove_dir_tree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># remove additional dirs</span>
    <span class="n">additionals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;singularity&#39;</span><span class="p">,</span> <span class="s1">&#39;pilot&#39;</span><span class="p">,</span> <span class="s1">&#39;cores&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">additional</span> <span class="ow">in</span> <span class="n">additionals</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">additional</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;removing </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> from workdir=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">additional</span><span class="p">,</span> <span class="n">workdir</span><span class="p">))</span>
            <span class="n">remove_dir_tree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">ls</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.download_command">[docs]</a><span class="k">def</span> <span class="nf">download_command</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the pre/postprocess commands if necessary.</span>

<span class="sd">    :param process: pre/postprocess dictionary.</span>
<span class="sd">    :param workdir: job workdir (string).</span>
<span class="sd">    :return: updated pre/postprocess dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># download the command if necessary</span>
    <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
        <span class="c1"># Try to download the trf (skip when user container is to be used)</span>
        <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">get_analysis_trf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;cannot execute command due to previous error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># update the preprocess command (the URL should be stripped)</span>
        <span class="n">process</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">cmd</span>

    <span class="k">return</span> <span class="n">process</span></div>


<div class="viewcode-block" id="get_utility_commands"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_utility_commands">[docs]</a><span class="k">def</span> <span class="nf">get_utility_commands</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a dictionary of utility commands and arguments to be executed in parallel with the payload.</span>
<span class="sd">    This could e.g. be memory and network monitor commands. A separate function can be used to determine the</span>
<span class="sd">    corresponding command setups using the utility command name.</span>
<span class="sd">    If the optional order parameter is set, the function should return the list of corresponding commands.</span>
<span class="sd">    E.g. if order=UTILITY_BEFORE_PAYLOAD, the function should return all commands that are to be executed before the</span>
<span class="sd">    payload. If order=UTILITY_WITH_PAYLOAD, the corresponding commands will be prepended to the payload execution</span>
<span class="sd">    string. If order=UTILITY_AFTER_PAYLOAD_STARTED, the commands that should be executed after the payload has been started</span>
<span class="sd">    should be returned. If order=UTILITY_WITH_STAGEIN, the commands that should be executed parallel with stage-in will</span>
<span class="sd">    be returned.</span>

<span class="sd">    FORMAT: {&#39;command&#39;: &lt;command&gt;, &#39;args&#39;: &lt;args&gt;}</span>

<span class="sd">    :param order: optional sorting order (see pilot.util.constants).</span>
<span class="sd">    :param job: optional job object.</span>
<span class="sd">    :return: dictionary of utilities to be executed in parallel with the payload.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">com</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_BEFORE_PAYLOAD</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">preprocess</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">preprocess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">download_command</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">preprocess</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_WITH_PAYLOAD</span><span class="p">:</span>
        <span class="n">com</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="s1">&#39;NetworkMonitor&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_AFTER_PAYLOAD_STARTED</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">utility_after_payload_started</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">com</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_AFTER_PAYLOAD_STARTED2</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">coprocess</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">coprocess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">download_command</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">coprocess</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_AFTER_PAYLOAD</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">download_command</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_AFTER_PAYLOAD_FINISHED</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">postprocess</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">download_command</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;pilotXcache&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">catchall</span><span class="p">:</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">xcache_deactivation_command</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">UTILITY_BEFORE_STAGEIN</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;pilotXcache&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">catchall</span><span class="p">:</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">xcache_activation_command</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">com</span></div>


<div class="viewcode-block" id="xcache_activation_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.xcache_activation_command">[docs]</a><span class="k">def</span> <span class="nf">xcache_activation_command</span><span class="p">(</span><span class="n">jobid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the xcache service activation command.</span>

<span class="sd">    :param jobid: PanDA job id to guarantee that xcache process is unique (int).</span>
<span class="sd">    :return: xcache command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># a successful startup will set ALRB_XCACHE_PROXY and ALRB_XCACHE_PROXY_REMOTE</span>
    <span class="c1"># so any file access with root://...  should be replaced with one of the above</span>
    <span class="c1"># (depending on whether you are on the same machine or not)</span>
    <span class="c1"># example:</span>
    <span class="c1"># ${ALRB_XCACHE_PROXY}root://atlasxrootd-kit.gridka.de:1094//pnfs/gridka.de/../DAOD_FTAG4.24348858._000020.pool.root.1</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">get_asetup</span><span class="p">(</span><span class="n">asetup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># add &#39;xcache list&#39; which will also kill any orphaned processes lingering in the system</span>
    <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;lsetup xcache; xcache list; xcache start -d $PWD/</span><span class="si">%s</span><span class="s2">/xcache -C centos7 --disklow 4g --diskhigh 5g&quot;</span> <span class="o">%</span> <span class="n">jobid</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="xcache_deactivation_command"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.xcache_deactivation_command">[docs]</a><span class="k">def</span> <span class="nf">xcache_deactivation_command</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the xcache service deactivation command.</span>
<span class="sd">    This service should be stopped after the payload has finished.</span>
<span class="sd">    Copy the messages log before shutting down.</span>

<span class="sd">    :param workdir: payload work directory (string).</span>
<span class="sd">    :return: xcache command (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ALRB_XCACHE_LOG&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;copying xcache messages log file (</span><span class="si">%s</span><span class="s1">) to work dir (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">workdir</span><span class="p">))</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;xcache-messages.log&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught copying xcache log: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">get_asetup</span><span class="p">(</span><span class="n">asetup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;lsetup xcache; xcache kill&quot;</span>  <span class="c1"># -C centos7</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="s1">&#39;-p all&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_utility_command_setup"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_utility_command_setup">[docs]</a><span class="k">def</span> <span class="nf">get_utility_command_setup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the proper setup for the given utility command.</span>
<span class="sd">    If a payload setup is specified, then the utility command string should be prepended to it.</span>

<span class="sd">    :param name: name of utility (string).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param setup: optional payload setup string.</span>
<span class="sd">    :return: utility command setup (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MemoryMonitor&#39;</span><span class="p">:</span>
        <span class="c1"># must know if payload is running in a container or not (enables search for pid in ps output)</span>
        <span class="n">use_container</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">usecontainer</span> <span class="ow">or</span> <span class="s1">&#39;runcontainer&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">transformation</span>
        <span class="n">dump_ps</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;PRMON_DEBUG&quot;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">catchall</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">setup</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">get_memory_monitor_setup</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">use_container</span><span class="o">=</span><span class="n">use_container</span><span class="p">,</span>
                                              <span class="n">transformation</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">outdata</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">,</span> <span class="n">dump_ps</span><span class="o">=</span><span class="n">dump_ps</span><span class="p">)</span>
        <span class="n">_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;([\S]+)\ .&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_pattern</span><span class="p">)</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">setup</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">_name</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">memorymonitor</span> <span class="o">=</span> <span class="n">_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;trf name could not be identified in setup string&#39;</span><span class="p">)</span>

        <span class="c1"># update the pgrp if the pid changed</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">pid</span> <span class="ow">and</span> <span class="n">pid</span> <span class="o">!=</span> <span class="o">--</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;updating pgrp=</span><span class="si">%d</span><span class="s1"> for pid=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">pgrp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;os.getpgid(</span><span class="si">%d</span><span class="s1">) failed with: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">setup</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NetworkMonitor&#39;</span> <span class="ow">and</span> <span class="n">setup</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_network_monitor_setup</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Prefetcher&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_prefetcher_setup</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Benchmark&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_benchmark_setup</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="get_utility_command_execution_order"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_utility_command_execution_order">[docs]</a><span class="k">def</span> <span class="nf">get_utility_command_execution_order</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Should the given utility command be executed before or after the payload?</span>

<span class="sd">    :param name: utility name (string).</span>
<span class="sd">    :return: execution order constant.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># example implementation</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NetworkMonitor&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UTILITY_WITH_PAYLOAD</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MemoryMonitor&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UTILITY_AFTER_PAYLOAD_STARTED</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;unknown utility name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">UTILITY_AFTER_PAYLOAD_STARTED</span></div>


<div class="viewcode-block" id="post_utility_command_action"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.post_utility_command_action">[docs]</a><span class="k">def</span> <span class="nf">post_utility_command_action</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform post action for given utility command.</span>

<span class="sd">    :param name: name of utility command (string).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NetworkMonitor&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MemoryMonitor&#39;</span><span class="p">:</span>
        <span class="n">post_memory_monitor_action</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_utility_command_kill_signal"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_utility_command_kill_signal">[docs]</a><span class="k">def</span> <span class="nf">get_utility_command_kill_signal</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the proper kill signal used to stop the utility command.</span>

<span class="sd">    :param name: name of utility command (string).</span>
<span class="sd">    :return: kill signal</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># note that the NetworkMonitor does not require killing (to be confirmed)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">SIGUSR1</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MemoryMonitor&#39;</span> <span class="k">else</span> <span class="n">SIGTERM</span>
    <span class="k">return</span> <span class="n">sig</span></div>


<div class="viewcode-block" id="get_utility_command_output_filename"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_utility_command_output_filename">[docs]</a><span class="k">def</span> <span class="nf">get_utility_command_output_filename</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the filename to the output of the utility command.</span>

<span class="sd">    :param name: utility name (string).</span>
<span class="sd">    :param selector: optional special conditions flag (boolean).</span>
<span class="sd">    :return: filename (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MemoryMonitor&#39;</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">get_memory_monitor_summary_filename</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="verify_lfn_length"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.verify_lfn_length">[docs]</a><span class="k">def</span> <span class="nf">verify_lfn_length</span><span class="p">(</span><span class="n">outdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure that the LFNs are all within the allowed length.</span>

<span class="sd">    :param outdata: FileSpec object.</span>
<span class="sd">    :return: error code (int), diagnostics (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ec</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">diagnostics</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="c1"># loop over all output files</span>
    <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">outdata</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="n">diagnostics</span> <span class="o">=</span> <span class="s2">&quot;LFN too long (length: </span><span class="si">%d</span><span class="s2">, must be less than </span><span class="si">%d</span><span class="s2"> characters): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                          <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">),</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">)</span>
            <span class="n">ec</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">LFNTOOLONG</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span></div>


<div class="viewcode-block" id="verify_ncores"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.verify_ncores">[docs]</a><span class="k">def</span> <span class="nf">verify_ncores</span><span class="p">(</span><span class="n">corecount</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that nCores settings are correct</span>

<span class="sd">    :param corecount: number of cores (int).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_PROC_NUMBER_JOB&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unset existing ATHENA_PROC_NUMBER_JOB&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">athena_proc_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ATHENA_PROC_NUMBER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">athena_proc_number</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Note: if ATHENA_PROC_NUMBER is set (by the wrapper), then do not overwrite it</span>
    <span class="c1"># Otherwise, set it to the value of job.coreCount</span>
    <span class="c1"># (actually set ATHENA_PROC_NUMBER_JOB and use it if it exists, otherwise use ATHENA_PROC_NUMBER directly;</span>
    <span class="c1"># ATHENA_PROC_NUMBER_JOB will always be the value from the job definition)</span>
    <span class="k">if</span> <span class="n">athena_proc_number</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;encountered a set ATHENA_PROC_NUMBER (</span><span class="si">%d</span><span class="s2">), will not overwrite it&quot;</span> <span class="o">%</span> <span class="n">athena_proc_number</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set ATHENA_CORE_NUMBER to same value as ATHENA_PROC_NUMBER&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_CORE_NUMBER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">athena_proc_number</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_PROC_NUMBER_JOB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">corecount</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ATHENA_CORE_NUMBER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">corecount</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;set ATHENA_PROC_NUMBER_JOB and ATHENA_CORE_NUMBER to </span><span class="si">%s</span><span class="s2"> (ATHENA_PROC_NUMBER will not be overwritten)&quot;</span> <span class="o">%</span> <span class="n">corecount</span><span class="p">)</span></div>


<div class="viewcode-block" id="verify_job"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.verify_job">[docs]</a><span class="k">def</span> <span class="nf">verify_job</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify job parameters for specific errors.</span>
<span class="sd">    Note:</span>
<span class="sd">      in case of problem, the function should set the corresponding pilot error code using</span>
<span class="sd">      job.piloterrorcodes, job.piloterrordiags = errors.add_error_code(error.get_error_code())</span>

<span class="sd">    :param job: job object</span>
<span class="sd">    :return: Boolean.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># are LFNs of correct lengths?</span>
    <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">verify_lfn_length</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">outdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiag</span> <span class="o">=</span> <span class="n">diagnostics</span>
        <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># check the ATHENA_PROC_NUMBER settings</span>
    <span class="n">verify_ncores</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">corecount</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="update_stagein"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.update_stagein">[docs]</a><span class="k">def</span> <span class="nf">update_stagein</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Skip DBRelease files during stage-in.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">fspec</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">indata</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;DBRelease&#39;</span> <span class="ow">in</span> <span class="n">fspec</span><span class="o">.</span><span class="n">lfn</span><span class="p">:</span>
            <span class="n">fspec</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;no_transfer&#39;</span></div>


<div class="viewcode-block" id="get_metadata"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.get_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the metadata from file.</span>

<span class="sd">    :param workdir: work directory (string)</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">jobreport</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;metadata=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="should_update_logstash"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.should_update_logstash">[docs]</a><span class="k">def</span> <span class="nf">should_update_logstash</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Should logstash be updated with prmon dictionary?</span>

<span class="sd">    :param frequency:</span>
<span class="sd">    :return: return True once per &#39;frequency&#39; times.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
    <span class="k">if</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="update_server"><a class="viewcode-back" href="../../../../components/user/atlas/common.html#pilot.user.atlas.common.update_server">[docs]</a><span class="k">def</span> <span class="nf">update_server</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform any user specific server actions.</span>

<span class="sd">    E.g. this can be used to send special information to a logstash.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># attempt to read memory_monitor_output.txt and convert it to json</span>
    <span class="k">if</span> <span class="n">should_update_logstash</span><span class="p">():</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">get_memory_monitor_output_filename</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="c1"># convert memory monitor text output to json and return the selection (don&#39;t store it, log has already been created)</span>
            <span class="n">metadata_dictionary</span> <span class="o">=</span> <span class="n">get_metadata_dict_from_txt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">storejson</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata_dictionary</span><span class="p">:</span>
                <span class="c1"># the output was previously written to file, update the path and tell curl to send it</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">update_extension</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
                <span class="c1">#out = read_json(new_path)</span>
                <span class="c1">#logger.debug(&#39;prmon json=\n%s&#39; % out)</span>
                <span class="c1"># logger.debug(&#39;final logstash prmon dictionary: %s&#39; % str(metadata_dictionary))</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://pilot.atlas-ml.org&#39;</span>  <span class="c1"># &#39;http://collector.atlas-ml.org:80&#39;</span>
                <span class="c1">#cmd = &quot;curl --connect-timeout 20 --max-time 120 -H \&quot;Content-Type: application/json\&quot; -X POST -d \&#39;%s\&#39; %s&quot; % \</span>
                <span class="c1">#      (str(metadata_dictionary).replace(&quot;&#39;&quot;, &#39;&quot;&#39;), url)</span>
                <span class="c1"># curl --connect-timeout 20 --max-time 120 -H &quot;Content-Type: application/json&quot; -X POST --upload-file test.json</span>
                <span class="c1"># https://pilot.atlas-ml.org</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;curl --connect-timeout 20 --max-time 120 -H </span><span class="se">\&quot;</span><span class="s2">Content-Type: application/json</span><span class="se">\&quot;</span><span class="s2"> -X POST --upload-file </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
                <span class="c1">#cmd = &quot;curl --connect-timeout 20 --max-time 120 -F &#39;data=@%s&#39; %s&quot; % (new_path, url)</span>
                <span class="c1"># send metadata to logstash</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">exit_code</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">usecontainer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sent prmon JSON dictionary to logstash server&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;stdout: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stdout</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;stderr: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no prmon json available - cannot send anything to logstash server&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;path does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no need to update logstash for this job&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Pilot 2</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../components/index.html">Components</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Paul Nilsson, Mario Lassnig, Daniil Drizhuk, ....
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>